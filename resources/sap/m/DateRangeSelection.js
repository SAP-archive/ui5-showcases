/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/Device","./DatePicker","./library","sap/ui/core/LocaleData","sap/ui/core/format/DateFormat","sap/ui/core/date/UniversalDate","./DateRangeSelectionRenderer","sap/base/util/deepEqual","sap/base/Log","sap/base/assert","sap/ui/dom/jquery/cursorPos"],function(e,t,i,a,s,n,r,o,l,u){"use strict";var h=t.extend("sap.m.DateRangeSelection",{metadata:{library:"sap.m",properties:{delimiter:{type:"string",group:"Misc",defaultValue:"-"},secondDateValue:{type:"object",group:"Data",defaultValue:null},from:{type:"object",group:"Misc",defaultValue:null,deprecated:true},to:{type:"object",group:"Misc",defaultValue:null,deprecated:true}},designtime:"sap/m/designtime/DateRangeSelection.designtime",dnd:{draggable:false,droppable:true}}});var p=String.fromCharCode(45),g=String.fromCharCode(8211),f=String.fromCharCode(8212);h.prototype.init=function(){t.prototype.init.apply(this,arguments);this._bIntervalSelection=true};h.prototype.onkeypress=function(e){if(!e.charCode||e.metaKey||e.ctrlKey){return}var t=v.call(this);var i=y.call(this);var a=t.sAllowedCharacters+i+" ";var s=String.fromCharCode(e.charCode);if(s&&t.sAllowedCharacters&&a.indexOf(s)<0){e.preventDefault()}};h.prototype._getPlaceholder=function(){var e=this.getPlaceholder(),t,i,s,n;if(!e){t=this.getBinding("value");s=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();n=a.getInstance(s);if(t&&t.getType()instanceof sap.ui.model.type.DateInterval){i=t.getType();if(i.oFormatOptions&&i.oFormatOptions.format){e=n.getCustomDateTimePattern(i.oFormatOptions.format)}else{e=n.getDatePattern("medium")}}else{e=this.getDisplayFormat();if(!e){e="medium"}if(this._checkStyle(e)){e=n.getDatePattern(e)}}var r=y.call(this);if(r&&r!==""){e=e+" "+r+" "+e}}return e};h.prototype.setValue=function(e){if(e!==this.getValue()){this._lastValue=e}else{return this}this.setProperty("value",e);this._bValid=true;var t=[undefined,undefined];if(e){t=this._parseValue(e);if(!m.call(this,t[0],t[1])[0]){this._bValid=false;l.warning("Value can not be converted to a valid dates",this)}}this.setProperty("dateValue",c(t[0]));this.setProperty("secondDateValue",c(t[1]));if(this.getDomRef()){var i=this._formatValue(t[0],t[1]);if(this._$input.val()!==i){this._$input.val(i);this._curpos=this._$input.cursorPos()}}return this};function c(e){return typeof e==="number"?new Date(e):e}function d(e){return e&&e.getTime?e.getTime():e}h.prototype.setValueFormat=function(e){this.setProperty("valueFormat",e,true);l.warning("Property valueFormat is not supported in sap.m.DateRangeSelection control.",this);return this};h.prototype.setDisplayFormat=function(e){this.setProperty("displayFormat",e,true);var t=this._formatValue(this.getDateValue(),this.getSecondDateValue());this.setProperty("value",t,true);if(this.getDomRef()&&this._$input.val()!==t){this._$input.val(t);this._curpos=this._$input.cursorPos()}return this};h.prototype.setFrom=function(e){this.setDateValue(e);return this};h.prototype.getFrom=function(){return this.getDateValue()};h.prototype.setTo=function(e){this.setSecondDateValue(e);return this};h.prototype.getTo=function(){return this.getSecondDateValue()};h.prototype.setDateValue=function(e){if(this._isValidDate(e)){throw new Error("Date must be a JavaScript date object; "+this)}if(o(this.getDateValue(),e)){return this}t.prototype._dateValidation.call(this,e);this._syncDateObjectsToValue(e,this.getSecondDateValue());return this};h.prototype.setSecondDateValue=function(e){if(this._isValidDate(e)){throw new Error("Date must be a JavaScript date object; "+this)}if(o(this.getSecondDateValue(),e)){return this}this._bValid=true;if(e&&(e.getTime()<this._oMinDate.getTime()||e.getTime()>this._oMaxDate.getTime())){this._bValid=false;u(this._bValid,"Date must be in valid range")}this.setProperty("secondDateValue",e);this._syncDateObjectsToValue(this.getDateValue(),e);return this};h.prototype.setMinDate=function(e){t.prototype.setMinDate.apply(this,arguments);if(e){var i=this.getSecondDateValue();if(i&&i.getTime()<this._oMinDate.getTime()){l.warning("SecondDateValue not in valid date range",this)}}return this};h.prototype.setMaxDate=function(e){t.prototype.setMaxDate.apply(this,arguments);if(e){var i=this.getSecondDateValue();if(i&&i.getTime()>this._oMaxDate.getTime()){l.warning("SecondDateValue not in valid date range",this)}}return this};h.prototype._checkMinMaxDate=function(){t.prototype._checkMinMaxDate.apply(this,arguments);var e=this.getSecondDateValue();if(e&&(e.getTime()<this._oMinDate.getTime()||e.getTime()>this._oMaxDate.getTime())){l.error("secondDateValue "+e.toString()+"(value="+this.getValue()+") does not match "+"min/max date range("+this._oMinDate.toString()+" - "+this._oMaxDate.toString()+"). App. "+"developers should take care to maintain secondDateValue/value accordingly.",this)}};h.prototype._parseValue=function(e){var t;var i=[];var a,s;var n=this.getBinding("value");if(n&&n.getType()instanceof sap.ui.model.type.DateInterval){try{i=n.getType().parseValue(e,"string")}catch(e){return[undefined,undefined]}if(n.getType().oFormatOptions&&n.getType().oFormatOptions.UTC){i=i.map(function(e){return new Date(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds())})}return i}var r=y.call(this);if(r&&e){e=e.trim();e=b(e,[r," "]);i=this._splitValueByDelimiter(e,r);if(i.length===2){if(i[0].slice(i[0].length-1,i[0].length)==" "){i[0]=i[0].slice(0,i[0].length-1)}if(i[1].slice(0,1)==" "){i[1]=i[1].slice(1)}}else{i=e.split(" "+r+" ")}if(e.indexOf(r)===-1){var o=e.split(" ");if(o.length===2){i=o}}}if(e&&i.length<=2){t=v.call(this);if(!r||r===""||i.length===1){a=t.parse(e)}else if(i.length===2){a=t.parse(i[0]);s=t.parse(i[1]);if(!a||!s){a=undefined;s=undefined}}}return[a,s]};h.prototype._splitValueByDelimiter=function(e,t){var i=[p,g,f],a;if(t){if(i.indexOf(t)===-1){return e.split(t)}}for(a=0;a<i.length;a++){if(e.indexOf(i[a])>0){return e.split(i[a])}}return e?e.split(" "):[]};h.prototype._formatValue=function(e,t){var i="",a=y.call(this),s,n,r,o;r=e;o=t;if(r){n=this.getBinding("value");if(n&&n.getType()instanceof sap.ui.model.type.DateInterval){if(n.getType().oFormatOptions&&n.getType().oFormatOptions.source&&n.getType().oFormatOptions.source.pattern==="timestamp"){i=n.getType().formatValue([d(e),d(t)],"string")}else{if(n.getType().oFormatOptions&&n.getType().oFormatOptions.UTC){r=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds()));if(t){o=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds()))}}i=n.getType().formatValue([r,o],"string")}}else{s=v.call(this);if(a&&a!==""&&o){i=s.format(r)+" "+a+" "+s.format(o)}else{i=s.format(r)}}}return i};h.prototype.onChange=function(){if(!this.getEditable()||!this.getEnabled()){return}var e=this._$input.val();var t=[undefined,undefined];this._bValid=true;if(e!=""){t=this._parseValue(e);t[1]&&t[1].setHours(23,59,59,999);t=m.call(this,t[0],t[1]);if(t[0]){e=this._formatValue(t[0],t[1])}else{this._bValid=false}}if(e!==this._lastValue){if(this.getDomRef()&&this._$input.val()!==e){this._$input.val(e);this._curpos=this._$input.cursorPos()}this._lastValue=e;this.setProperty("value",e,true);if(this._bValid){this.setProperty("dateValue",c(t[0]),true);this.setProperty("secondDateValue",c(t[1]),true)}if(this._oPopup&&this._oPopup.isOpen()){var i=this.getDateValue();if(i){if(!this._oDateRange.getStartDate()||this._oDateRange.getStartDate().getTime()!==i.getTime()){this._oDateRange.setStartDate(new Date(i.getTime()));this._oCalendar.focusDate(i)}}else{if(this._oDateRange.getStartDate()){this._oDateRange.setStartDate(undefined)}}var a=this.getSecondDateValue();if(a){if(!this._oDateRange.getEndDate()||this._oDateRange.getEndDate().getTime()!==a.getTime()){this._oDateRange.setEndDate(new Date(a.getTime()));this._oCalendar.focusDate(a)}}else{if(this._oDateRange.getEndDate()){this._oDateRange.setEndDate(undefined)}}}D.call(this,this._bValid)}};h.prototype._getInputValue=function(e){e=typeof e=="undefined"?this._$input.val():e.toString();var t=this._parseValue(e);e=this._formatValue(t[0],t[1]);return e};h.prototype.updateDomValue=function(e){this._bCheckDomValue=true;e=typeof e=="undefined"?this._$input.val():e.toString();this._curpos=this._$input.cursorPos();var t=this._parseValue(e);e=this._formatValue(t[0],t[1]);if(this.isActive()&&this._$input.val()!==e){this._$input.val(e);this._$input.cursorPos(this._curpos)}return this};h.prototype.onsappageup=function(e){this._increaseDateRange(1,"day");e.preventDefault()};h.prototype.onsappageupmodifiers=function(e){if(e.shiftKey&&!e.ctrlKey){this._increaseDateRange(1,"month")}else if(e.shiftKey&&e.ctrlKey){this._increaseDateRange(1,"year")}e.preventDefault()};h.prototype.onsappagedown=function(e){this._increaseDateRange(-1,"day");e.preventDefault()};h.prototype.onsappagedownmodifiers=function(e){if(e.shiftKey&&!e.ctrlKey){this._increaseDateRange(-1,"month")}else if(e.shiftKey&&e.ctrlKey){this._increaseDateRange(-1,"year")}e.preventDefault()};h.prototype._fillDateRange=function(){t.prototype._fillDateRange.apply(this,arguments);var e=this.getSecondDateValue();if(e&&e.getTime()>=this._oMinDate.getTime()&&e.getTime()<=this._oMaxDate.getTime()){if(!this._oDateRange.getEndDate()||this._oDateRange.getEndDate().getTime()!==e.getTime()){this._oDateRange.setEndDate(new Date(e.getTime()))}}else{if(this._oDateRange.getEndDate()){this._oDateRange.setEndDate(undefined)}}};h.prototype._selectDate=function(t){var i=this._oCalendar.getSelectedDates();if(i.length>0){var a=i[0].getStartDate();var s=i[0].getEndDate();if(a&&s){var n=this.getDateValue();var r=this.getSecondDateValue();s.setHours(23,59,59,999);var l;if(!o(a,n)||!o(s,r)){if(o(s,r)){this.setDateValue(a)}else{this.setProperty("dateValue",a,true);this.setSecondDateValue(s)}l=this.getValue();D.call(this,true);if(e.system.desktop||!e.support.touch){this._curpos=l.length;this._$input.cursorPos(this._curpos)}}else if(!this._bValid){l=this._formatValue(a,s);if(l!=this._$input.val()){this._bValid=true;if(this.getDomRef()){this._$input.val(l)}D.call(this,true)}}this._oPopup.close()}}};h.prototype.getAccessibilityInfo=function(){var e=this.getRenderer();var i=t.prototype.getAccessibilityInfo.apply(this,arguments);var a=this.getValue()||"";if(this._bValid){var s=this.getDateValue();if(s){a=this._formatValue(s,this.getSecondDateValue())}}i.description=[a,e.getLabelledByAnnouncement(this),e.getDescribedByAnnouncement(this)].join(" ").trim();return i};h.prototype._syncDateObjectsToValue=function(e,t){var i=this._formatValue(e,t);if(i!==this.getValue()){this._lastValue=i}this.setProperty("value",i);if(this.getDomRef()){var a=this._formatValue(e,t);if(this._$input.val()!==a){this._$input.val(a);this._curpos=this._$input.cursorPos()}}};function D(e){this.fireChangeEvent(this.getValue(),{from:this.getDateValue(),to:this.getSecondDateValue(),valid:e})}function m(e,t){var i,a;if(e&&e.getTime){i=e.getTime()}else if(typeof e==="number"){i=e}if(t&&t.getTime){a=t.getTime()}else if(typeof t==="number"){a=t}if(e&&t&&i>a){var s=e;e=t;t=s}if(e&&(i<this._oMinDate.getTime()||i>this._oMaxDate.getTime())||t&&(a<this._oMinDate.getTime()||a>this._oMaxDate.getTime())){return[undefined,undefined]}else{return[e,t]}}h.prototype._increaseDateRange=function(e,t){var i=this._$input.val(),a=this._parseValue(i),s=a[0],n=a[1],r=v.call(this),u=y.call(this),h,p,g,f,c,d,V;if(!this.getEditable()||!this.getEnabled()){return}if(!m.call(this,s,n)[0]){l.warning("Value can not be converted to a valid dates or dates are outside of the min/max range",this);this._bValid=false;D.call(this,this._bValid);return}i=b(i,[u," "]);h=this._$input.cursorPos();p=r.format(s).length;g=r.format(n).length;f=i.length;c=h<=p+1;d=h>=f-g-1&&h<=f;if(c&&s){V=_.call(this,s,e,t);if(!o(this.getDateValue(),V.getJSDate())){this.setDateValue(new Date(V.getTime()));this._curpos=h;this._$input.cursorPos(this._curpos);this.fireChangeEvent(this.getValue(),{valid:this._bValid})}}else if(d&&n){V=_.call(this,n,e,t);if(!o(this.getSecondDateValue(),V.getJSDate())){this.setSecondDateValue(new Date(V.getTime()));this._curpos=h;this._$input.cursorPos(this._curpos);this.fireChangeEvent(this.getValue(),{valid:this._bValid})}}};function _(e,t,i){var a=this.getBinding("value"),s,r,o,l;if(a&&a.oType&&a.oType.oOutputFormat){s=a.oType.oOutputFormat.oFormatOptions.calendarType}else if(a&&a.oType&&a.oType.oFormat){s=a.oType.oFormat.oFormatOptions.calendarType}if(!s){s=this.getDisplayFormatType()}o=n.getInstance(new Date(e.getTime()),s);l=o.getMonth();switch(i){case"day":o.setDate(o.getDate()+t);break;case"month":o.setMonth(o.getMonth()+t);r=(l+t)%12;if(r<0){r=12+r}while(o.getMonth()!=r){o.setDate(o.getDate()-1)}break;case"year":o.setFullYear(o.getFullYear()+t);while(o.getMonth()!=l){o.setDate(o.getDate()-1)}break;default:break}if(o.getTime()<this._oMinDate.getTime()){o=new n(this._oMinDate.getTime())}else if(o.getTime()>this._oMaxDate.getTime()){o=new n(this._oMaxDate.getTime())}return o}function y(){var e=this.getDelimiter();if(!e){if(!this._sLocaleDelimiter){var t=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var i=a.getInstance(t);var s=i.getIntervalPattern();var n=s.indexOf("{0}")+3;var r=s.indexOf("{1}");e=s.slice(n,r);if(e.length>1){if(e.slice(0,1)==" "){e=e.slice(1)}if(e.slice(e.length-1,e.length)==" "){e=e.slice(0,e.length-1)}}this._sLocaleDelimiter=e}else{e=this._sLocaleDelimiter}}return e}function v(){var e=this.getDisplayFormat()||"medium";var t;var i=this.getDisplayFormatType();if(e==this._sUsedDisplayPattern&&i==this._sUsedDisplayCalendarType){t=this._oDisplayFormat}else{if(this._checkStyle(e)){t=s.getInstance({style:e,strictParsing:true,calendarType:i})}else{t=s.getInstance({pattern:e,strictParsing:true,calendarType:i})}this._sUsedDisplayPattern=e;this._sUsedDisplayCalendarType=i;this._oDisplayFormat=t}return t}function V(e,t){return e&&t&&e.lastIndexOf(t)===e.length-t.length}function T(e,t){return e&&t&&e.indexOf(t)===0}function b(e,t){var i=0,a=t;if(!a){a=[" "]}while(i<a.length){if(V(e,a[i])){e=e.substring(0,e.length-a[i].length);i=0;continue}i++}i=0;while(i<a.length){if(T(e,a[i])){e=e.substring(a[i].length);i=0;continue}i++}return e}return h});