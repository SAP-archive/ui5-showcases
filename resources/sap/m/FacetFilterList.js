/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./List","./library","sap/ui/model/ChangeReason","sap/ui/model/Filter","./FacetFilterListRenderer","./FacetFilterItem","sap/base/Log"],function(e,t,i,s,r,o,a){"use strict";var l=t.ListMode;var n=t.FacetFilterListDataType;var c=e.extend("sap.m.FacetFilterList",{metadata:{library:"sap.m",properties:{title:{type:"string",group:"Appearance",defaultValue:null},wordWrap:{type:"boolean",group:"Appearance",defaultValue:false},multiSelect:{type:"boolean",group:"Behavior",defaultValue:true,deprecated:true},active:{type:"boolean",group:"Behavior",defaultValue:true},enableCaseInsensitiveSearch:{type:"boolean",group:"Behavior",defaultValue:false,deprecated:false},allCount:{type:"int",group:"Appearance",defaultValue:null},sequence:{type:"int",group:"Behavior",defaultValue:-1},key:{type:"string",group:"Identification",defaultValue:null},showRemoveFacetIcon:{type:"boolean",group:"Misc",defaultValue:true},retainListSequence:{type:"boolean",group:"Misc",defaultValue:false},dataType:{type:"sap.m.FacetFilterListDataType",group:"Misc",defaultValue:n.String}},events:{listOpen:{},listClose:{parameters:{selectedItems:{type:"sap.m.FacetFilterItem[]"},allSelected:{type:"boolean"},selectedKeys:{type:"object"}}}}}});c.prototype.setTitle=function(e){this.setProperty("title",e,true);this._updateFacetFilterButtonText();return this};c.prototype.setMultiSelect=function(e){this.setProperty("multiSelect",e,true);var t=e?l.MultiSelect:l.SingleSelectMaster;this.setMode(t);return this};c.prototype.setMode=function(t){if(t===l.MultiSelect||t===l.SingleSelectMaster){e.prototype.setMode.call(this,t);this.setProperty("multiSelect",t===l.MultiSelect?true:false,true)}return this};c.prototype._applySearch=function(){var e=this._getSearchValue();if(e!=null){this._search(e,true);this._updateSelectAllCheckBox()}};c.prototype.getSelectedItems=function(){var t=[];var i={};var s=e.prototype.getSelectedItems.apply(this,arguments);s.forEach(function(e){t.push(new o({text:e.getText(),key:e.getKey(),selected:true}));i[e.getKey()]=true});var r=this.getSelectedKeys();var a=Object.getOwnPropertyNames(r);if(s.length<a.length){a.forEach(function(e){if(!i[e]){t.push(new o({text:r[e],key:e,selected:true}))}})}return t};c.prototype.getSelectedItem=function(){var t=e.prototype.getSelectedItem.apply(this,arguments);var i=Object.getOwnPropertyNames(this.getSelectedKeys());if(!t&&i.length>0){t=new o({text:this.getSelectedKeys()[i[0]],key:i[0],selected:true})}return t};c.prototype.removeSelections=function(t){if(this._allowRemoveSelections){t?this.setSelectedKeys():e.prototype.removeSelections.call(this,t)}return this};c.prototype.getSelectedKeys=function(){var e={};var t=this._oSelectedKeys;Object.getOwnPropertyNames(t).forEach(function(i){e[i]=t[i]});return e};c.prototype.setSelectedKeys=function(t){this._oSelectedKeys={};var i=false;t&&Object.getOwnPropertyNames(t).forEach(function(e){this._addSelectedKey(e,t[e]);i=true},this);if(i){if(this.getMode()===l.MultiSelect){this.setActive(true)}this._selectItemsByKeys()}else{e.prototype.removeSelections.call(this)}};c.prototype._getNonGroupItems=function(){var e=[];this.getItems().forEach(function(t){if(t.getMode()!==l.None){e.push(t)}});return e};c.prototype.removeSelectedKey=function(e,t){if(this._removeSelectedKey(e,t)){this._getNonGroupItems().forEach(function(t){var i=t.getKey()||t.getText();e===i&&t.setSelected(false)})}};c.prototype.removeSelectedKeys=function(){this._oSelectedKeys={};e.prototype.removeSelections.call(this,true)};c.prototype.removeItem=function(t){var i=e.prototype.removeItem.apply(this,arguments);if(!this._filtering){i&&i.getSelected()&&this.removeSelectedKey(i.getKey(),i.getText());return i}};c.prototype.init=function(){this._firstTime=true;this._saveBindInfo;this._oSelectedKeys={};e.prototype.init.call(this);this.setMode(l.MultiSelect);this.setIncludeItemInSelection(true);this.setGrowing(true);this.setRememberSelections(false);this._searchValue="";this.attachUpdateFinished(function(e){var t=e.getParameter("reason");t=t?t.toLowerCase():t;if(t==="change"){var s=this.getBinding("items"),r=s?s.getModel():null;if(r&&r.getProperty(s.getPath())){this._iAllItemsCount=r.getProperty(s.getPath()).length||0}}if(t!=="growing"&&t!==i.Filter.toLowerCase()){this._oSelectedKeys={};this._getNonGroupItems().forEach(function(e){if(e.getSelected()){this._addSelectedKey(e.getKey(),e.getText())}},this)}if(t!==i.Filter.toLowerCase()){this._selectItemsByKeys()}this._updateFacetFilterButtonText();this._updateSelectAllCheckBox()});this._allowRemoveSelections=true;this._bOriginalActiveState;this._iAllItemsCount};c.prototype._resetItemsBinding=function(){if(this.isBound("items")){this._searchValue="";this._allowRemoveSelections=false;e.prototype._resetItemsBinding.apply(this,arguments);this._allowRemoveSelections=true}};c.prototype._fireListCloseEvent=function(){var e=this.getSelectedItems();var t=this.getSelectedKeys();var i=e.length===0;this._firstTime=true;this.fireListClose({selectedItems:e,selectedKeys:t,allSelected:i})};c.prototype._updateActiveState=function(){var e=sap.ui.getCore().byId(this.getAssociation("allcheckbox"));if(Object.getOwnPropertyNames(this._oSelectedKeys).length>0||e&&e.getSelected()){this.setActive(true)}};c.prototype._handleSearchEvent=function(e){var t=e.getParameters()["query"];if(t===undefined){t=e.getParameters()["newValue"]}this._search(t);this._updateSelectAllCheckBox()};c.prototype._search=function(e,t){var i;var r=0;function o(e){return e instanceof sap.ui.model.odata.ODataModel||e instanceof sap.ui.model.odata.v2.ODataModel}if(t||e!==this._searchValue){this._searchValue=e;var l=this.getBinding("items");var n=this.getBindingInfo("items");if(n&&n.binding){i=n.binding.aFilters;if(i.length>0){r=i[0].aFilters.length;if(this._firstTime){this._saveBindInfo=i[0].aFilters[0][0];this._firstTime=false}}}if(l){if(e||r>0){var c=this.getBindingInfo("items").template.getBindingInfo("text").parts;var h=c[0].path;if(h||h===""){var p=new s(h,sap.ui.model.FilterOperator.Contains,e);var u=[p];for(var d=1;d<c.length;d++){u.push(new s(c[d].path,sap.ui.model.FilterOperator.Contains,e))}if(this.getEnableCaseInsensitiveSearch()&&o(l.getModel())){var f="'"+String(e).replace(/'/g,"''")+"'";f=f.toLowerCase();p=new s("tolower("+h+")",sap.ui.model.FilterOperator.Contains,f);u=[p];for(var d=1;d<c.length;d++){u.push(new s("tolower("+c[d].path+")",sap.ui.model.FilterOperator.Contains,e))}}var g=new s(u,false);if(r>1){var y=new s([g,this._saveBindInfo],true)}else{if(this._saveBindInfo>""&&p.sPath!=this._saveBindInfo.sPath){var y=new s([g,this._saveBindInfo],true)}else{if(e==""){var y=[]}else{var y=new s([g],true)}}}l.filter(y,sap.ui.model.FilterType.Control)}}else{l.filter([],sap.ui.model.FilterType.Control)}}else{a.warning("No filtering performed","The list must be defined with a binding for search to work",this)}}};c.prototype._getSearchValue=function(){return this._searchValue};c.prototype._updateSelectAllCheckBox=function(){var e=this._getNonGroupItems(),t=e.length,i,s,r;function o(e){return e.getSelected()}if(this.getMultiSelect()){i=sap.ui.getCore().byId(this.getAssociation("allcheckbox"));s=t>0&&t===e.filter(o).length;r=this.getActive()&&s;i&&i.setSelected(r)}};c.prototype._addSelectedKey=function(e,t){if(!e&&!t){a.error("Both sKey and sText are not defined. At least one must be defined.");return}if(this.getMode()===l.SingleSelectMaster){this.removeSelectedKeys()}if(!e){e=t}this._oSelectedKeys[e]=t||e};c.prototype._removeSelectedKey=function(e,t){if(!e&&!t){a.error("Both sKey and sText are not defined. At least one must be defined.");return false}if(!e){e=t}delete this._oSelectedKeys[e];return true};c.prototype._setSearchValue=function(e){this._searchValue=e};c.prototype._isItemSelected=function(e){return!!this._oSelectedKeys[e&&(e.getKey()||e.getText())]};c.prototype._updateFacetFilterButtonText=function(){if(this.getParent()&&this.getParent()._setButtonText){this.getParent()._setButtonText(this)}};c.prototype._selectItemsByKeys=function(){this._getNonGroupItems().forEach(function(e){e.setSelected(this._isItemSelected(e))},this);this._updateFacetFilterButtonText()};c.prototype._handleSelectAllClick=function(e){var t;this._getNonGroupItems().forEach(function(t){if(e){this._addSelectedKey(t.getKey(),t.getText())}else{this._removeSelectedKey(t.getKey(),t.getText())}t.setSelected(e,true)},this);if(this.getMode()===l.MultiSelect){t=this._getOriginalActiveState()||e;this.setActive(t)}setTimeout(this._updateSelectAllCheckBox.bind(this),0)};c.prototype.onItemTextChange=function(e,t){var i=e.getKey();if(this._oSelectedKeys[i]&&t&&!this._filtering){this._oSelectedKeys[i]=t}};c.prototype.onItemSelectedChange=function(t,i){var s;if(i){this._addSelectedKey(t.getKey(),t.getText())}else{this._removeSelectedKey(t.getKey(),t.getText())}e.prototype.onItemSelectedChange.apply(this,arguments);if(this.getMode()===l.MultiSelect){s=this._getOriginalActiveState()||i||this.getSelectedItems().length>1;this.setActive(s)}!this.getDomRef()&&this.getParent()&&this.getParent().getDomRef()&&this.getParent().invalidate();setTimeout(this._updateSelectAllCheckBox.bind(this),0)};c.prototype.updateItems=function(t){this._filtering=t===i.Filter;e.prototype.updateItems.apply(this,arguments);this._filtering=false;if(!this.getGrowing()||t===i.Filter){this._selectItemsByKeys()}};c.prototype._getOriginalActiveState=function(){return this._bOriginalActiveState};c.prototype._preserveOriginalActiveState=function(){this._bOriginalActiveState=this.getActive()};return c});