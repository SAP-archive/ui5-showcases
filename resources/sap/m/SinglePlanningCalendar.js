/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","./PlanningCalendarHeader","./SegmentedButtonItem","./SinglePlanningCalendarWeekView","./SinglePlanningCalendarGrid","./SinglePlanningCalendarRenderer","sap/base/Log","sap/ui/core/Control","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/ui/core/InvisibleText","sap/ui/core/ResizeHandler","sap/ui/core/date/UniversalDate","sap/ui/core/format/DateFormat","sap/ui/unified/calendar/CalendarDate","sap/ui/unified/calendar/CalendarUtils","sap/ui/unified/DateRange","sap/ui/base/ManagedObjectObserver"],function(e,t,i,a,r,s,n,o,l,g,p,d,h,c,u,_,f,m){"use strict";var y=e.PlanningCalendarStickyMode;var D="_sHeaderResizeHandlerId";var w=4;var S=o.extend("sap.m.SinglePlanningCalendar",{metadata:{library:"sap.m",properties:{title:{type:"string",group:"Appearance",defaultValue:""},startDate:{type:"object",group:"Data"},stickyMode:{type:"sap.m.PlanningCalendarStickyMode",group:"Behavior",defaultValue:y.None},enableAppointmentsDragAndDrop:{type:"boolean",group:"Misc",defaultValue:false},enableAppointmentsResize:{type:"boolean",group:"Misc",defaultValue:false},enableAppointmentsCreate:{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{actions:{type:"sap.ui.core.Control",multiple:true,singularName:"action",forwarding:{getter:"_getHeader",aggregation:"actions"}},appointments:{type:"sap.ui.unified.CalendarAppointment",multiple:true,singularName:"appointment",forwarding:{getter:"_getGrid",aggregation:"appointments"}},views:{type:"sap.m.SinglePlanningCalendarView",multiple:true,singularName:"view"},specialDates:{type:"sap.ui.unified.DateTypeRange",multiple:true,singularName:"specialDate",forwarding:{getter:"_getGrid",aggregation:"specialDates"}},_header:{type:"sap.m.PlanningCalendarHeader",multiple:false,visibility:"hidden"},_grid:{type:"sap.m.SinglePlanningCalendarGrid",multiple:false,visibility:"hidden"}},associations:{selectedView:{type:"sap.m.SinglePlanningCalendarView",multiple:false},legend:{type:"sap.m.PlanningCalendarLegend",multiple:false}},events:{appointmentSelect:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},appointments:{type:"sap.ui.unified.CalendarAppointment[]"}}},appointmentDrop:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},startDate:{type:"object"},endDate:{type:"object"},copy:{type:"boolean"}}},appointmentResize:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},startDate:{type:"object"},endDate:{type:"object"}}},appointmentCreate:{parameters:{startDate:{type:"object"},endDate:{type:"object"}}},headerDateSelect:{parameters:{date:{type:"object"}}},startDateChange:{parameters:{date:{type:"object"}}},cellPress:{parameters:{startDate:{type:"object"},endDate:{type:"object"}}}}}});S.prototype.init=function(){var e=this.getId();this._oRB=sap.ui.getCore().getLibraryResourceBundle("sap.m");this._oDefaultView=new a({key:"DEFAULT_INNER_WEEK_VIEW_CREATED_FROM_CONTROL",title:""});this.setAssociation("selectedView",this._oDefaultView);this.setAggregation("_header",this._createHeader());this.setAggregation("_grid",new r(e+"-Grid"));this._attachHeaderEvents();this._attachGridEvents();this._attachDelegates();this.setStartDate(new Date)};S.prototype.onBeforeRendering=function(){this._toggleStickyClasses()};S.prototype.onAfterRendering=function(){var e=this._getHeader();this._adjustColumnHeadersTopOffset();this.toggleStyleClass("sapMSinglePCActionsHidden",!e._getActionsToolbar().getVisible());this._registerResizeHandler(D,e,this._onHeaderResize.bind(this))};S.prototype.exit=function(){if(this._oDefaultView){this._oDefaultView.destroy();this._oDefaultView=null}if(this._afterRenderFocusCell){this.removeDelegate(this._afterRenderFocusCell);this._afterRenderFocusCell=null}this._deRegisterResizeHandler(D)};S.prototype._onHeaderResize=function(e){if(e.oldSize.height===e.size.height){return this}this.toggleStyleClass("sapMSinglePCActionsHidden",!this._getHeader()._getActionsToolbar().getVisible());this._adjustColumnHeadersTopOffset();return this};S.prototype.setTitle=function(e){this._getHeader().setTitle(e);return this.setProperty("title",e,true)};S.prototype.setStartDate=function(e){this.setProperty("startDate",e,true);this._alignColumns();return this};S.prototype.setEnableAppointmentsDragAndDrop=function(e){this._getGrid().setEnableAppointmentsDragAndDrop(e);return this.setProperty("enableAppointmentsDragAndDrop",e,true)};S.prototype.setEnableAppointmentsResize=function(e){this._getGrid().setEnableAppointmentsResize(e);return this.setProperty("enableAppointmentsResize",e,true)};S.prototype.setEnableAppointmentsCreate=function(e){this._getGrid().setEnableAppointmentsCreate(e);return this.setProperty("enableAppointmentsCreate",e,true)};S.prototype._toggleStickyClasses=function(){var e=this.getStickyMode();this.toggleStyleClass("sapMSinglePCStickyAll",e===y.All);this.toggleStyleClass("sapMSinglePCStickyNavBarAndColHeaders",e===y.NavBarAndColHeaders);return this};S.prototype._adjustColumnHeadersTopOffset=function(){var e=this.getStickyMode(),t=this._getGrid(),i=t&&t._getColumnHeaders(),a;if(!i||!i.getDomRef()){return this}switch(e){case y.All:a=this._getHeader().$().outerHeight();break;case y.NavBarAndColHeaders:a=this._getHeader()._getNavigationToolbar().$().outerHeight();break;default:a="auto";break}i.$().css("top",a);i._setTopPosition(a);return this};S.prototype.addView=function(e){var t,a=this._getHeader();if(!e){return this}if(this._isViewKeyExisting(e.getKey())){n.error("There is an existing view with the same key.",this);return this}this.addAggregation("views",e);t=a._getOrCreateViewSwitch();t.addItem(new i({key:e.getKey(),text:e.getTitle()}));if(this._getSelectedView().getKey()===this._oDefaultView.getKey()){this.setAssociation("selectedView",e)}this._alignView();if(this.getViews().length>w){a._convertViewSwitchToSelect()}return this};S.prototype.insertView=function(e,t){var a,r=this._getHeader();if(!e){return this}if(this._isViewKeyExisting(e.getKey())){n.error("There is an existing view with the same key.",this);return this}this.insertAggregation("views",e,t);a=r._getOrCreateViewSwitch();a.insertItem(new i({key:e.getKey(),text:e.getTitle()}),t);if(this._getSelectedView().getKey()===this._oDefaultView.getKey()){this.setAssociation("selectedView",e)}this._alignView();if(this.getViews().length>w){r._convertViewSwitchToSelect()}return this};S.prototype.removeView=function(e){if(!e){return this}var t=this._getHeader(),i=t._getOrCreateViewSwitch(),a=i.getItems(),r=this._getSelectedView(),s=e.getKey(),n,o;for(o=0;o<a.length;o++){n=a[o];if(n.getKey()===s){i.removeItem(n);break}}this.removeAggregation("views",e);if(s===r.getKey()){this.setAssociation("selectedView",this.getViews()[0]||this._oDefaultView)}this._alignView();if(this.getViews().length<=w){t._convertViewSwitchToSegmentedButton()}return this};S.prototype.removeAllViews=function(){var e=this._getHeader()._getOrCreateViewSwitch();e.removeAllItems();this.setAssociation("selectedView",this._oDefaultView);this._alignView();return this.removeAllAggregation("views")};S.prototype.destroyViews=function(){var e=this._getHeader()._getOrCreateViewSwitch();e.destroyItems();this.setAssociation("selectedView",this._oDefaultView);this._alignView();return this.destroyAggregation("views")};S.prototype.getSelectedAppointments=function(){return this._getGrid().getSelectedAppointments()};S.prototype.setLegend=function(e){var t,i;this.setAssociation("legend",e);this._getGrid().setAssociation("legend",e);if(this.getLegend()){this._getGrid()._sLegendId=this.getLegend();i=sap.ui.getCore().byId(this.getLegend())}if(i){t=new m(function(e){this.invalidate()}.bind(this));t.observe(i,{destroy:true})}return this};S.prototype._alignView=function(){this._switchViewButtonVisibility();this._alignColumns();return this};S.prototype._createHeader=function(){var e=new t(this.getId()+"-Header");e.getAggregation("_actionsToolbar").addAriaLabelledBy(p.getStaticId("sap.m","SPC_ACTIONS_TOOLBAR"));e.getAggregation("_navigationToolbar").addAriaLabelledBy(p.getStaticId("sap.m","SPC_NAVIGATION_TOOLBAR"));return e};S.prototype._isViewKeyExisting=function(e){return this.getViews().some(function(t){return t.getKey()===e})};S.prototype._getSelectedView=function(){var e,t=this.getViews(),i=sap.ui.getCore().byId(this.getAssociation("selectedView")).getKey();for(var a=0;a<t.length;a++){if(i===t[a].getKey()){e=t[a];break}}return e||this._oDefaultView};S.prototype._switchViewButtonVisibility=function(){var e=this._getHeader()._getOrCreateViewSwitch(),t=e.getItems().length>1;e.setProperty("visible",t);return this};S.prototype._attachHeaderEvents=function(){var e=this._getHeader();e.attachEvent("pressPrevious",this._handlePressArrow,this);e.attachEvent("pressToday",this._handlePressToday,this);e.attachEvent("pressNext",this._handlePressArrow,this);e.attachEvent("dateSelect",this._handleCalendarPickerDateSelect,this);e._getOrCreateViewSwitch().attachEvent("selectionChange",this._handleViewSwitchChange,this);return this};S.prototype._attachDelegates=function(){this._afterRenderFocusCell={onAfterRendering:function(){if(this._sGridCellFocusSelector){jQuery(this._sGridCellFocusSelector).focus();this._sGridCellFocusSelector=null}}.bind(this)};this._getGrid().addDelegate(this._afterRenderFocusCell)};S.prototype._attachGridEvents=function(){var e=this._getGrid();e._getColumnHeaders().attachEvent("select",function(e){this.fireHeaderDateSelect({date:e.getSource().getDate()})},this);e.attachEvent("appointmentSelect",function(e){this.fireAppointmentSelect({appointment:e.getParameter("appointment"),appointments:e.getParameter("appointments")})},this);e.attachEvent("appointmentDrop",function(e){this.fireAppointmentDrop({appointment:e.getParameter("appointment"),startDate:e.getParameter("startDate"),endDate:e.getParameter("endDate"),copy:e.getParameter("copy")})},this);e.attachEvent("appointmentResize",function(e){this.fireAppointmentResize({appointment:e.getParameter("appointment"),startDate:e.getParameter("startDate"),endDate:e.getParameter("endDate")})},this);e.attachEvent("appointmentCreate",function(e){this.fireAppointmentCreate({startDate:e.getParameter("startDate"),endDate:e.getParameter("endDate")})},this);e.attachEvent("cellPress",function(e){this.fireEvent("cellPress",{startDate:e.getParameter("startDate"),endDate:e.getParameter("endDate")})},this);e.attachEvent("borderReached",function(e){var t=this._getGrid(),i=t._getDateFormatter(),a=this._getSelectedView().getScrollEntityCount()-t._getColumns()+1,r=new Date(e.getParameter("startDate")),s=e.getParameter("fullDay"),n=this.getStartDate();if(e.getParameter("next")){r.setDate(r.getDate()+a);n=new Date(n.setDate(n.getDate()+this._getSelectedView().getScrollEntityCount()));this.setStartDate(n)}else{r.setDate(r.getDate()-a);n=new Date(n.setDate(n.getDate()-this._getSelectedView().getScrollEntityCount()));this.setStartDate(n)}this._sGridCellFocusSelector=s?"[data-sap-start-date='"+i.format(r)+"'].sapMSinglePCBlockersColumn":"[data-sap-start-date='"+i.format(r)+"'].sapMSinglePCRow"},this);return this};S.prototype._handlePressArrow=function(e){this._applyArrowsLogic(e.getId()==="pressPrevious");this._adjustColumnHeadersTopOffset()};S.prototype._handlePressToday=function(){var e=this._getSelectedView().calculateStartDate(new Date);this.setStartDate(e);this.fireStartDateChange({date:e});this._adjustColumnHeadersTopOffset()};S.prototype._handleViewSwitchChange=function(e){this.setAssociation("selectedView",e.getParameter("item"));this._alignColumns();this._adjustColumnHeadersTopOffset()};S.prototype._handleCalendarPickerDateSelect=function(){var e=this._getHeader().getStartDate(),t;t=this._getSelectedView().calculateStartDate(new Date(e.getTime()));this.setStartDate(t);this._getGrid()._getColumnHeaders().setDate(e);this.fireStartDateChange({date:t});this._adjustColumnHeadersTopOffset()};S.prototype._updateCalendarPickerSelection=function(){var e=this._getFirstAndLastRangeDate(),t;t=new f({startDate:e.oStartDate.toLocalJSDate(),endDate:e.oEndDate.toLocalJSDate()});this._getHeader().getAggregation("_calendarPicker").removeAllSelectedDates();this._getHeader().getAggregation("_calendarPicker").addSelectedDate(t)};S.prototype._formatPickerText=function(){var e=this._getFirstAndLastRangeDate(),t=e.oStartDate.toLocalJSDate(),i=e.oEndDate.toLocalJSDate(),a=c.getDateInstance({style:"long"}),r=a.format(t);if(t.getTime()!==i.getTime()){r+=" - "+a.format(i)}return r};S.prototype._applyArrowsLogic=function(e){var t=u.fromLocalJSDate(this.getStartDate()||new Date),i=this._getSelectedView().getScrollEntityCount(),a;if(e){i*=-1}t.setDate(t.getDate()+i);a=t.toLocalJSDate();this.setStartDate(a);this.fireStartDateChange({date:a})};S.prototype._getFirstAndLastRangeDate=function(){var e=this._getSelectedView(),t=this._getHeader().getStartDate()||new Date,i=e.getEntityCount()-1,a,r;a=u.fromLocalJSDate(e.calculateStartDate(new Date(t.getTime())));r=new u(a);r.setDate(a.getDate()+i);return{oStartDate:a,oEndDate:r}};S.prototype._alignColumns=function(){var e=this._getHeader(),t=this._getGrid(),i=this._getSelectedView(),a=this.getStartDate()||new Date,r=i.calculateStartDate(new Date(a.getTime())),s=u.fromLocalJSDate(r);e.setStartDate(r);e.setPickerText(this._formatPickerText(s));this._updateCalendarPickerSelection();t.setStartDate(r);t._setColumns(i.getEntityCount());this._setColumnHeaderVisibility()};S.prototype._setColumnHeaderVisibility=function(){var e=!this._getSelectedView().isA("sap.m.SinglePlanningCalendarDayView");this._getGrid()._getColumnHeaders().setVisible(e);this.toggleStyleClass("sapMSinglePCHiddenColHeaders",!e)};S.prototype._getHeader=function(){return this.getAggregation("_header")};S.prototype._getGrid=function(){return this.getAggregation("_grid")};S.prototype._registerResizeHandler=function(e,t,i){if(!this[e]){this[e]=d.register(t,i)}return this};S.prototype._deRegisterResizeHandler=function(e){if(this[e]){d.deregister(this[e]);this[e]=null}return this};return S});