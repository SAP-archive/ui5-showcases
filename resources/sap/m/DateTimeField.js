/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/model/type/Date","sap/ui/model/odata/type/ODataType","./InputBase","sap/ui/core/LocaleData","sap/ui/core/library","sap/ui/core/format/DateFormat","./DateTimeFieldRenderer","sap/base/util/deepEqual","sap/base/Log","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/cursorPos"],function(t,e,a,i,r,s,o,n,u,l){"use strict";var p=r.CalendarType;var h=a.extend("sap.m.DateTimeField",{metadata:{abstract:true,library:"sap.m",properties:{displayFormat:{type:"string",group:"Appearance",defaultValue:null},valueFormat:{type:"string",group:"Data",defaultValue:null},dateValue:{type:"object",group:"Data",defaultValue:null},initialFocusedDateValue:{type:"object",group:"Data",defaultValue:null}}}});h.prototype.setValue=function(t){t=this.validateProperty("value",t);var e=this.getValue();if(t===e){return this}else{this._lastValue=t}this.setProperty("value",t);this._bValid=true;var a;if(t){a=this._parseValue(t);if(!a||a.getTime()<this._oMinDate.getTime()||a.getTime()>this._oMaxDate.getTime()){this._bValid=false;u.warning("Value can not be converted to a valid date",this)}}this.setProperty("dateValue",a);if(this.getDomRef()){var i;if(a){i=this._formatValue(a)}else{i=t}if(this._$input.val()!==i){this._$input.val(i);this._curpos=this._$input.cursorPos()}}return this};h.prototype.setDateValue=function(t){if(this._isValidDate(t)){throw new Error("Date must be a JavaScript date object; "+this)}if(n(this.getDateValue(),t)){return this}t=this._dateValidation(t);var e=this._formatValue(t,true);if(e!==this.getValue()){this._lastValue=e}this.setProperty("value",e);if(this.getDomRef()){var a=this._formatValue(t);if(this._$input.val()!==a){this._$input.val(a);this._curpos=this._$input.cursorPos()}}return this};h.prototype.setValueFormat=function(t){this.setProperty("valueFormat",t,true);var e=this.getValue();if(e){this._handleDateValidation(this._parseValue(e))}return this};h.prototype.setDisplayFormat=function(t){this.setProperty("displayFormat",t,true);this.updateDomValue(this._formatValue(this.getDateValue()));this._updateDomPlaceholder(this._getPlaceholder());return this};h.prototype.getDisplayFormatType=function(){return null};h.prototype._dateValidation=function(t){this._bValid=true;this.setProperty("dateValue",t);return t};h.prototype._handleDateValidation=function(t){this._bValid=true;this.setProperty("dateValue",t)};h.prototype._getPlaceholder=function(){var t=this.getPlaceholder();if(!t){t=this._getDisplayFormatPattern();if(!t){t=this._getDefaultDisplayStyle()}if(this._checkStyle(t)){t=this._getLocaleBasedPattern(t)}}return t};h.prototype._getLocaleBasedPattern=function(t){return i.getInstance(sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale()).getDatePattern(t)};h.prototype._parseValue=function(t,e){var a=this.getBinding("value"),i=a&&a.getType&&a.getType(),r,s,o;if(i&&this._isSupportedBindingType(i)){try{o=i.parseValue(t,"string");r=i.oFormatOptions;if(r&&r.source&&r.source.pattern=="timestamp"){o=new Date(o)}}catch(t){}if(o&&(i.oFormatOptions&&i.oFormatOptions.UTC||i.oConstraints&&i.oConstraints.isDateOnly)){s=new Date(o.getUTCFullYear(),o.getUTCMonth(),o.getUTCDate(),o.getUTCHours(),o.getUTCMinutes(),o.getUTCSeconds(),o.getUTCMilliseconds());s.setFullYear(o.getUTCFullYear());o=s}return o}return this._getFormatter(e).parse(t)};h.prototype._formatValue=function(t,e){if(!t){return""}var a=this.getBinding("value"),i=a&&a.getType&&a.getType(),r,s;if(i&&this._isSupportedBindingType(i)){if(i.oFormatOptions&&i.oFormatOptions.UTC||i.oConstraints&&i.oConstraints.isDateOnly){s=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()));s.setUTCFullYear(t.getFullYear());t=s}r=i.oFormatOptions;if(r&&r.source&&r.source.pattern=="timestamp"){t=t.getTime()}return i.formatValue(t,"string")}return this._getFormatter(!e).format(t)};h.prototype._isSupportedBindingType=function(t){return t.isA(["sap.ui.model.type.Date","sap.ui.model.odata.type.DateTime","sap.ui.model.odata.type.DateTimeOffset"])};h.prototype._getDefaultDisplayStyle=function(){return"medium"};h.prototype._getDefaultValueStyle=function(){return"short"};h.prototype._getFormatter=function(t){var e=this._getBoundValueTypePattern(),a=false,i,r=this.getBinding("value"),s;if(r&&r.oType&&r.oType.oOutputFormat){a=!!r.oType.oOutputFormat.oFormatOptions.relative;s=r.oType.oOutputFormat.oFormatOptions.calendarType}if(!e){if(t){e=this.getDisplayFormat()||this._getDefaultDisplayStyle();s=this.getDisplayFormatType()}else{e=this.getValueFormat()||this._getDefaultValueStyle();s=p.Gregorian}}if(!s){s=sap.ui.getCore().getConfiguration().getCalendarType()}if(t){if(e===this._sUsedDisplayPattern&&s===this._sUsedDisplayCalendarType){i=this._oDisplayFormat}}else{if(e===this._sUsedValuePattern&&s===this._sUsedValueCalendarType){i=this._oValueFormat}}if(i){return i}return this._getFormatterInstance(i,e,a,s,t)};h.prototype._getFormatterInstance=function(t,e,a,i,r){if(this._checkStyle(e)){t=this._getFormatInstance({style:e,strictParsing:true,relative:a,calendarType:i},r)}else{t=this._getFormatInstance({pattern:e,strictParsing:true,relative:a,calendarType:i},r)}if(r){this._sUsedDisplayPattern=e;this._sUsedDisplayCalendarType=i;this._oDisplayFormat=t}else{this._sUsedValuePattern=e;this._sUsedValueCalendarType=i;this._oValueFormat=t}return t};h.prototype._getFormatInstance=function(t,e){return s.getInstance(t)};h.prototype._checkStyle=function(t){return t==="short"||t==="medium"||t==="long"||t==="full"};h.prototype._getDisplayFormatPattern=function(){var t=this._getBoundValueTypePattern();if(t){return t}t=this.getDisplayFormat();if(this._checkStyle(t)){t=this._getLocaleBasedPattern(t)}return t};h.prototype._getBoundValueTypePattern=function(){var a=this.getBinding("value"),i=a&&a.getType&&a.getType();if(i instanceof t){return i.getOutputPattern()}if(i instanceof e&&i.oFormat){return i.oFormat.oFormatOptions.pattern}return undefined};h.prototype._isValidDate=function(t){return t&&l.type(t)!=="date"};h.prototype._updateDomPlaceholder=function(t){if(this.getDomRef()){this._$input.attr("placeholder",t)}};return h});