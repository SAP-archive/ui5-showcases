/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/Device","sap/ui/thirdparty/jquery","sap/ui/test/_LogCollector","sap/ui/test/_OpaLogger","sap/ui/test/_ParameterValidator","sap/ui/test/_UsageReport","sap/ui/test/_OpaUriParameterParser"],function(e,t,r,n,i,o,a){"use strict";var s=n.getLogger("sap.ui.test.Opa"),u=r.getInstance(),c=[],f={},l=-1,g,p,d,v,m=new i({errorPrefix:"sap.ui.test.Opa#waitFor"});u.start();function h(e,t){if(window["sap-ui-debug"]){t.timeout=t.debugTimeout}var r=new Date;n();function n(){s.timestamp("opa.check");u.getAndClearLog();var i=e();v=t._stack;if(i.error){p.reject(t);return}if(i.result){_();return}var o=(new Date-r)/1e3;if(t.timeout===0||t.timeout>o){l=setTimeout(n,t.pollingInterval);return}y("Opa timeout after "+t.timeout+" seconds",t);if(t.error){try{t.error(t,i.arguments)}finally{p.reject(t)}}else{p.reject(t)}}}function _(){if(!c.length){if(p){p.resolve()}return true}var e=c.shift();l=setTimeout(function(){h(e.callback,e.options)},(F.config.asyncPolling?e.options.pollingInterval:0)+F.config.executionDelay)}function w(e,t){var r=e.get();if(r){var n=c.splice(c.length-r,r);n.forEach(function(e){e.options._nestedIn=t});c=n.concat(c)}}function k(e){var t=e.toString();if(e.stack){t+="\n"+e.stack}var r="Exception thrown by the testcode:'"+t+"'";return r}function y(e,t,r){var n=u.getAndClearLog();if(n){e+="\nThis is what Opa logged:\n"+n}if(!r&&t._stack){e+=O(t)}if(t.errorMessage){t.errorMessage+="\n"+e}else{t.errorMessage=e}s.error(t.errorMessage,"Opa")}function C(t){t=(t||0)+2;if(e.browser.mozilla){t=t-1}var r=new Error,n=r.stack;if(!n){try{throw r()}catch(e){n=e.stack}}if(!n){return""}n=n.split("\n");n.splice(0,t);return n.join("\n")}function O(e){var t="\nCallstack:\n";if(e._stack){t+=e._stack;delete e._stack}else{t+="Unknown"}if(e._nestedIn){t+=O(e._nestedIn);delete e._nestedIn}return t}var F=function(e){this.and=this;t.extend(this,e)};F.config={};F.extendConfig=function(e){var r=["actions","assertions","arrangements"];r.filter(function(t){return!!e[t]}).forEach(function(t){var r=e[t];var n=Object.getPrototypeOf(e[t]);var i=F.config[t];var o=Object.getPrototypeOf(F.config[t]);for(var a in i){if(!(a in r)){r[a]=i[a]}}for(var s in o){if(!(s in r)){n[s]=o[s]}}});F.config=t.extend(true,F.config,e,b);n.setLevel(F.config.logLevel)};var b=a._getOpaParams();var x=0;var P=e.browser.safari&&!e.browser.phantomJS;if(e.browser.msie||e.browser.edge||P){x=50}F.resetConfig=function(){F.config=t.extend({arrangements:new F,actions:new F,assertions:new F,timeout:15,pollingInterval:400,debugTimeout:0,_stackDropCount:0,executionDelay:x,asyncPolling:false},b)};F.getContext=function(){return f};F.emptyQueue=function e(){if(d){throw new Error("Opa is emptying its queue. Calling Opa.emptyQueue() is not supported at this time.")}d=true;g=null;p=t.Deferred();_();return p.promise().fail(function(e){c=[];if(g){var t=g.qunitTimeout?"QUnit timeout after "+g.qunitTimeout+" seconds":"Queue was stopped manually";e._stack=g.qunitTimeout&&v||C(1);y(t,e)}}).always(function(){c=[];l=-1;p=null;v=null;d=false})};F.stopQueue=function e(){F._stopQueue()};F._stopQueue=function(e){c=[];if(!p){s.warning("stopQueue was called before emptyQueue, queued tests have never been executed","Opa")}else{if(l!==-1){clearTimeout(l)}g=e||{};p.reject(g)}};F.resetConfig();F._usageReport=new o(F.config);n.setLevel(F.config.logLevel);F.prototype={getContext:F.getContext,waitFor:function(e){var r=t.Deferred(),n=F._createFilteredConfig(F._aConfigValuesForWaitFor);e=t.extend({},n,e);this._validateWaitFor(e);e._stack=C(1+e._stackDropCount);delete e._stackDropCount;var i=t.extend({},this);r.promise(i);c.push({callback:function(){var t=true;if(e.check){try{t=e.check.apply(this,arguments)}catch(t){var n="Failure in Opa check function\n"+k(t);y(n,e,t.stack);r.reject(e);return{error:true,arguments:arguments}}}if(g){return{result:true,arguments:arguments}}if(!t){return{result:false,arguments:arguments}}if(e.success){var i=F._getWaitForCounter();try{e.success.apply(this,arguments)}catch(t){var n="Failure in Opa success function\n"+k(t);y(n,e,t.stack);r.reject(e);return{error:true,arguments:arguments}}finally{w(i,e)}}r.resolve();return{result:true,arguments:arguments}}.bind(this),options:e});return i},extendConfig:F.extendConfig,emptyQueue:F.emptyQueue,iWaitForPromise:function(e){return this._schedulePromiseOnFlow(e)},_schedulePromiseOnFlow:function(e,t){t=t||{};var r={};t.check=function(){if(!r.started){r.started=true;e.then(function(){r.done=true},function(e){r.errorMessage="Error while waiting for promise scheduled on flow"+(e?", details: "+e:"")})}if(r.errorMessage){throw new Error(r.errorMessage)}else{return!!r.done}};return this.waitFor(t)},_validateWaitFor:function(e){m.validate({validationInfo:F._validationInfo,inputToValidate:e})}};F._createFilteredOptions=function(e,t){var r={};e.forEach(function(e){var n=t[e];if(n===undefined){return}r[e]=n});return r};F._createFilteredConfig=function(e){return F._createFilteredOptions(e,F.config)};F._getWaitForCounter=function(){var e=c.length;return{get:function(){var t=c.length-e;return Math.max(t,0)}}};F._aConfigValuesForWaitFor=["errorMessage","timeout","debugTimeout","pollingInterval","_stackDropCount","asyncPolling"];F._validationInfo={error:"func",check:"func",success:"func",timeout:"numeric",debugTimeout:"numeric",pollingInterval:"numeric",_stackDropCount:"numeric",errorMessage:"string",asyncPolling:"bool"};return F},true);