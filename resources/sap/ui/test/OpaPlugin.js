/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
(function(t){"use strict";var e;if(t.module){e=t.module;t.module=undefined}sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/Object","sap/ui/core/Element","sap/ui/core/mvc/View","sap/ui/test/matchers/Ancestor","sap/ui/test/matchers/MatcherFactory","sap/ui/test/pipelines/MatcherPipeline","sap/ui/test/_OpaLogger"],function(t,e,n,r,i,o,s,l){var a=new o;var u=new s;var g=["id","viewName","viewId","controlType","searchOpenDialogs"];var f=e.extend("sap.ui.test.OpaPlugin",{constructor:function(){this._oLogger=l.getLogger("sap.ui.test.Opa5")},getAllControls:function(t,e){var r=n.registry.filter(c(t));this._oLogger.debug("Found "+r.length+" controls"+(t?" of type '"+(e||t)+"'":"")+" in page");return r},getView:function(t){var e=this.getAllControls(r,"View");var n=e.filter(function(e){return e.getViewName()===t});this._oLogger.debug("Found "+n.length+" views with viewName '"+t+"'");if(n.length>1){n=n.filter(function(t){var e=t.$();return e.length>0&&e.is(":visible")&&e.css("visibility")!=="hidden"});this._oLogger.debug("Found "+n.length+" visible views with viewName '"+t+"'");if(n.length!==1){this._oLogger.debug("Cannot identify controls uniquely. Please provide viewId to locate the exact view.");n=[]}}return n[0]},_getMatchingView:function(t){var e=null;var i;if(t.viewName){var o=(t.viewNamespace||"")+"."+(t.viewName||"");i=o.replace(/\.+/g,".").replace(/^\.|\.$/g,"")}if(t.viewId){var s=n.registry.get(t.viewId);if(s instanceof r&&(!i||s.getViewName()===i)){e=s}}else{e=this.getView(i)}this._oLogger.debug("Found "+(e?"":"no ")+"view with ID '"+t.viewId+"' and viewName '"+i+"'");return e},getControlInView:function(e){var n=this._getMatchingView(e);var r=typeof e.id==="string";if(!n){return r?null:[]}var i=n.getViewName();var o=e.fragmentId?e.fragmentId+f.VIEW_ID_DELIMITER:"";if(t.isArray(e.id)){var s=[];var l=[];e.id.map(function(t){return o+t}).forEach(function(t){var e=n.byId(t);if(e){s.push(e)}else{l.push(t)}});var a=l.length?". Found no controls matching the subset of IDs "+l:"";this._oLogger.debug("Found "+s.length+" controls with ID contained in "+e.id+" in view '"+i+"'"+a);return s}if(r){var u=o+e.id;var g=n.byId(u)||null;this._oLogger.debug("Found "+(g?"":"no ")+"control with ID '"+u+"' in view '"+i+"'");return g}var c=this.getAllControlsWithTheParent(n,e.controlType,e.sOriginalControlType);var d=t.type(e.id)==="regexp";if(d){c=c.filter(function(t){var r=this._getUnprefixedControlId(t.getId(),n.getId(),e.fragmentId);return e.id.test(r)}.bind(this))}this._oLogger.debug("Found "+c.length+" controls of type "+e.sOriginalControlType+(d?" with ID matching "+e.id:"")+" in view '"+i+"'");return c},getAllControlsWithTheParent:function(t,e,n){var r=new i(t);return this._filterUniqueControlsByCondition(this.getAllControls(e,n),r)},getAllControlsInContainer:function(t,e,n,r){var i=c(e),o=this._filterUniqueControlsByCondition(this._getControlsInContainer(t),i);this._oLogger.debug("Found "+o.length+" controls in "+(r?r:"container")+" with controlType '"+n+"'");return o},_getControlsInStaticArea:function(e){var n=this._getControlsInContainer(t("#sap-ui-static"))||[];if(e.id){n=this._filterUniqueControlsByCondition(n,function(n){var r=n.getId();var i=this._getMatchingView(e);if(i){if(this._isControlInView(n,i.getViewName())){r=this._getUnprefixedControlId(n.getId(),i.getId(),e.fragmentId)}}var o=false;if(typeof e.id==="string"){o=r===e.id}if(t.type(e.id)==="regexp"){o=e.id.test(r)}if(t.isArray(e.id)){o=e.id.filter(function(t){return t===r}).length>0}return o}.bind(this));this._oLogger.debug("Found "+(n.length?n.length:"no")+" controls in the static area with ID matching '"+e.id+"'"+(e.fragmentId?" and fragmentId: '"+e.fragmentId+"'":""))}if(n.length&&e.controlType){var r=c(e.controlType);n=this._filterUniqueControlsByCondition(n,r);this._oLogger.debug("Found "+(n.length?n.length:"no")+" controls in the static area with control type matching '"+e.controlType+"'")}if(e.id&&typeof e.id==="string"){return n[0]||null}else{return n}},_getControlsInContainer:function(t){return t.find("*").control()},_isControlInView:function(t,e){if(!t){return false}if(t.getViewName&&t.getViewName()===e){return true}else{return this._isControlInView(t.getParent(),e)}},getMatchingControls:function(e){var n=null;e=e||{};var r=this._modifyControlType(e);if(!r){return typeof e.id==="string"?n:[]}if(e.searchOpenDialogs){n=this._getControlsInStaticArea(e)}else if(e.viewName||e.viewId){n=this.getControlInView(e)}else if(e.id){n=this.getControlByGlobalId(e)}else if(e.controlType){n=this.getAllControls(e.controlType,e.sOriginalControlType)}else{n=this.getAllControls()}if(!n){return n}var i=a.getStateMatchers({visible:e.visible,interactable:e.interactable,enabled:typeof e.enabled==="undefined"?e.interactable:e.enabled});var o=u.process({control:n,matchers:i});if(!o){if(t.isArray(n)){return[]}if(n){return null}return n}return o},_getFilteredControls:function(t){var e=this._filterControlsByCondition(t);return e===f.FILTER_FOUND_NO_CONTROLS?f.FILTER_FOUND_NO_CONTROLS:this._filterControlsByMatchers(t,e)},_getFilteredControlsByDeclaration:function(e){var n=this._filterControlsByCondition(e);var r=t.extend({},e,{useDeclarativeMatchers:true});return n===f.FILTER_FOUND_NO_CONTROLS?f.FILTER_FOUND_NO_CONTROLS:this._filterControlsByMatchers(r,n)},_filterControlsByCondition:function(e){var n=null;var r=this._isLookingForAControl(e);if(r){n=this.getMatchingControls(e)}var i=[typeof e.id==="string"&&!n,t.type(e.id)==="regexp"&&!n.length,t.isArray(e.id)&&(!n||n.length!==e.id.length),e.controlType&&t.isArray(n)&&!n.length,!e.id&&(e.viewName||e.viewId||e.searchOpenDialogs)&&!n.length];return i.some(Boolean)?f.FILTER_FOUND_NO_CONTROLS:n},_filterControlsByMatchers:function(t,e){var n=t.useDeclarativeMatchers?a.getFilteringMatchers(t):t.matchers;var r=this._isLookingForAControl(t);var i=null;if((e||!r)&&n){i=u.process({matchers:n,control:e});if(!i){return f.FILTER_FOUND_NO_CONTROLS}}else{i=e}return i},getControlByGlobalId:function(e){var r=c(e.controlType);if(typeof e.id==="string"){var i=n.registry.get(e.id)||null;if(i&&!r(i)){this._oLogger.error("A control with global ID '"+e.id+"' is found but does not have required controlType '"+e.sOriginalControlType+"'. Found control is '"+i+"' but null is returned instead");return null}this._oLogger.debug("Found "+(i?"":"no ")+"control with the global ID '"+e.id+"'");return i}var o=[];var s=t.type(e.id)==="regexp";if(s){n.registry.forEach(function(t,n){if(e.id.test(n)){o.push(n)}})}else if(t.isArray(e.id)){o=e.id}var l=[];var a=[];o.forEach(function(t){var e=n.registry.get(t);if(e&&r(e)&&!e.bIsDestroyed){l.push(e)}else{a.push(t)}});var u=!s&&a.length?". Found no controls of matching the subset of IDs "+a:"";this._oLogger.debug("Found "+l.length+" controls of type "+e.sOriginalControlType+(s?" with ID matching '":" with ID contained in '")+e.id+u);return l},getControlConstructor:function(e){if(sap.ui.lazyRequire._isStub(e)){this._oLogger.debug("The control type "+e+" is currently a lazy stub.");return null}var n=t.sap.getObject(e);if(!n){this._oLogger.debug("The control type "+e+" is undefined.");return null}return n},_isLookingForAControl:function(t){return Object.keys(t).some(function(e){return g.indexOf(e)!==-1&&!!t[e]})},_filterUniqueControlsByCondition:function(t,e){return t.filter(function(t,n,r){var i=!!e(t);return i&&r.indexOf(t)===n})},_modifyControlType:function(t){var e=t.controlType;if(typeof e!=="string"){if(e&&e._sapUiLazyLoader){this._oLogger.debug("The control type is currently a lazy stub");return false}return true}var n=this.getControlConstructor(e);if(!n){return false}t.sOriginalControlType=e;t.controlType=n;return true},_getUnprefixedControlId:function(t,e,n){var r=t.replace(e+f.VIEW_ID_DELIMITER,"");if(n){if(r.startsWith(n+f.VIEW_ID_DELIMITER)){r=r.replace(n+f.VIEW_ID_DELIMITER,"")}else{r=""}}return r}});function c(e){if(e){t.sap.assert(typeof e==="function","fnControlType must be a function or falsy");return function(t){return t instanceof e}}else{return function(){return true}}}f.FILTER_FOUND_NO_CONTROLS="FILTER_FOUND_NO_CONTROL";f.VIEW_ID_DELIMITER="--";return f});if(e){t.module=e}})(window);