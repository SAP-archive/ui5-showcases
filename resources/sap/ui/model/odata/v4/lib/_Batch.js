/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.script","./_Helper","sap/base/strings/escapeRegExp"],function(e,n,r){"use strict";var t={POST:true,PUT:true,PATCH:true,DELETE:true},i,o=/\$\d+/,a=/(\S*?)=(?:"(.+)"|(\S+))/;function s(e){var n=c(e,"boundary"),t=e.trim().indexOf("multipart/mixed");if(t!==0||!n){throw new Error('Invalid $batch response header "Content-Type": '+e)}n=r(n);return new RegExp("--"+n+"(?:[ \t]*\r\n|--)")}function c(e,n){var r,t=e.split(";"),i;n=n.toLowerCase();for(r=1;r<t.length;r+=1){i=a.exec(t[r]);if(i[1].toLowerCase()===n){return i[2]||i[3]}}}function u(e){var n=d(e,"content-type");return n.indexOf("multipart/mixed;")===0?n:undefined}function f(e){var n=d(e,"content-id"),r;if(!n){throw new Error("Content-ID MIME header missing for the change set response.")}r=parseInt(n);if(isNaN(r)){throw new Error("Invalid Content-ID value in change set response.")}return r}function d(e,n){var r,t,i=e.split("\r\n");for(r=0;r<i.length;r+=1){t=i[r].split(":");if(t[0].toLowerCase().trim()===n){return t[1].trim()}}}function p(e,n,r){var t=n.split(s(e)),i=[];t=t.slice(1,-1);t.forEach(function(e){var n,t,o,a,s,d,h,l,y,m,T,E,w,C={},v;w=e.indexOf("\r\n\r\n");E=e.slice(0,w);y=e.indexOf("\r\n\r\n",w+4);l=e.slice(w+4,y);n=u(E);if(n){i.push(p(n,e.slice(w+4),true));return}h=l.split("\r\n");m=h[0].split(" ");C.status=parseInt(m[1]);C.statusText=m.slice(2).join(" ");C.headers={};for(T=1;T<h.length;T+=1){a=h[T];o=a.indexOf(":");s=a.slice(0,o).trim();d=a.slice(o+1).trim();C.headers[s]=d;if(s.toLowerCase()==="content-type"){t=c(d,"charset");if(t&&t.toLowerCase()!=="utf-8"){throw new Error('Unsupported "Content-Type" charset: '+t)}}}C.responseText=e.slice(y+4,-2);if(r){v=f(E);i[v]=C}else{i.push(C)}});return i}function h(e){var n,r=[];for(n in e){r=r.concat(n,":",e[n],"\r\n")}return r}function l(r,i){var a=(i!==undefined?"changeset_":"batch_")+e.sap.uid(),s=i!==undefined,c=[];if(s){c=c.concat("Content-Type: multipart/mixed;boundary=",a,"\r\n\r\n")}r.forEach(function(e,r){var u="",f=e.url;if(s){u="Content-ID:"+r+"."+i+"\r\n"}c=c.concat("--",a,"\r\n");if(Array.isArray(e)){if(s){throw new Error("Change set must not contain a nested change set.")}c=c.concat(l(e,r).body)}else{if(s&&!t[e.method]){throw new Error("Invalid HTTP request method: "+e.method+". Change set must contain only POST, PUT, PATCH or DELETE requests.")}f=f.replace(o,"$&."+i);c=c.concat("Content-Type:application/http\r\n","Content-Transfer-Encoding:binary\r\n",u,"\r\n",e.method," ",f," HTTP/1.1\r\n",h(n.resolveIfMatchHeader(e.headers)),"\r\n",JSON.stringify(e.body)||"","\r\n")}});c=c.concat("--",a,"--\r\n");return{body:c,batchBoundary:a}}i={deserializeBatchResponse:function(e,n){return p(e,n,false)},serializeBatchRequest:function(e){var n=l(e);return{body:n.body.join(""),headers:{"Content-Type":"multipart/mixed; boundary="+n.batchBoundary,"MIME-Version":"1.0"}}}};return i},false);