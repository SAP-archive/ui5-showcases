/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./lib/_Helper","sap/ui/base/SyncPromise","sap/ui/model/ChangeReason","sap/ui/model/odata/OperationMode","sap/ui/model/odata/v4/Context","sap/ui/thirdparty/jquery"],function(e,t,n,o,r,i){"use strict";var s=[n.Change,n.Refresh,n.Sort,n.Filter],a="sap.ui.model.odata.v4.ODataBinding",h=/\/\d|\(\$uid=/;function u(){this.mCacheByResourcePath=undefined;this.oCachePromise=t.resolve();this.mCacheQueryOptions=undefined;this.oFetchCacheCallToken=undefined;this.sResumeChangeReason=n.Change}u.prototype.checkBindingParameters=function(e,t){var n=this;Object.keys(e).forEach(function(r){var i=e[r];if(r.indexOf("$$")!==0){return}if(t.indexOf(r)<0){throw new Error("Unsupported binding parameter: "+r)}switch(r){case"$$aggregation":break;case"$$groupId":case"$$updateGroupId":n.oModel.checkGroupId(i,false,"Unsupported value for binding parameter '"+r+"': ");break;case"$$inheritExpandSelect":if(i!==true&&i!==false){throw new Error("Unsupported value for binding parameter "+"'$$inheritExpandSelect': "+i)}if(!n.oOperation){throw new Error("Unsupported binding parameter $$inheritExpandSelect: "+"binding is not an operation binding")}if(e.$expand||e.$select){throw new Error("Must not set parameter $$inheritExpandSelect on a binding "+"which has a $expand or $select binding parameter")}break;case"$$operationMode":if(i!==o.Server){throw new Error("Unsupported operation mode: "+i)}break;case"$$canonicalPath":case"$$ownRequest":case"$$patchWithoutSideEffects":if(i!==true){throw new Error("Unsupported value for binding parameter '"+r+"': "+i)}break;default:throw new Error("Unknown binding-specific parameter: "+r)}})};u.prototype.checkSuspended=function(){var e=this.getRootBinding();if(e&&e.isSuspended()){throw new Error("Must not call method when the binding's root binding is suspended: "+this)}};u.prototype.checkUpdate=function(e){var t=this;if(arguments.length>1){throw new Error("Only the parameter bForceUpdate is supported")}this.checkUpdateInternal(e).catch(function(e){t.oModel.reportError("Failed to update "+t,a,e)})};u.prototype.destroy=function(){this.mCacheByResourcePath=undefined;this.oCachePromise.then(function(e){if(e){e.setActive(false)}},function(){});this.oCachePromise=t.resolve();this.mCacheQueryOptions=undefined;this.oContext=undefined;this.oFetchCacheCallToken=undefined};u.prototype.fetchCache=function(n){var o,s={},h,u,c=this;if(!this.bRelative){n=undefined}if(this.oCachePromise.isFulfilled()){h=this.oCachePromise.getResult();if(h){h.setActive(false)}}u=[this.fetchQueryOptionsForOwnCache(n),this.oModel.oRequestor.ready()];this.mCacheQueryOptions=undefined;o=t.all(u).then(function(t){var a=t[0];if(a&&!(n&&n.iIndex===r.VIRTUAL)){return c.fetchResourcePath(n).then(function(t){var r,h,u,d;if(!o||c.oFetchCacheCallToken===s){c.mCacheQueryOptions=i.extend(true,{},c.oModel.mUriParameters,a);if(c.bRelative){c.mCacheByResourcePath=c.mCacheByResourcePath||{};r=c.mCacheByResourcePath[t];d=n.getReturnValueContextId&&n.getReturnValueContextId();if(r&&r.$returnValueContextId===d){r.setActive(true)}else{h=e.buildPath(n.getPath(),c.sPath).slice(1);r=c.doCreateCache(t,c.mCacheQueryOptions,n,h);c.mCacheByResourcePath[t]=r;r.$deepResourcePath=h;r.$resourcePath=t;r.$returnValueContextId=d}}else{r=c.doCreateCache(t,c.mCacheQueryOptions,n)}return r}else{u=new Error("Cache discarded as a new cache has been created");u.canceled=true;throw u}})}});o.catch(function(e){c.oModel.reportError("Failed to create cache for binding "+c,a,e)});this.oCachePromise=o;this.oFetchCacheCallToken=s};u.prototype.fetchQueryOptionsForOwnCache=function(e){var n,o,r=this;if(this.oOperation||this.bRelative&&!e||this.isMeta()){return t.resolve(undefined)}o=this.doFetchQueryOptions(e);if(this.oModel.bAutoExpandSelect&&this.aChildCanUseCachePromises){o=t.all([o,Promise.resolve().then(function(){return t.all(r.aChildCanUseCachePromises)})]).then(function(e){r.aChildCanUseCachePromises=[];r.updateAggregatedQueryOptions(e[0]);return r.mAggregatedQueryOptions})}if(!this.bRelative||!e.fetchValue){return o}if(this.oModel.bAutoExpandSelect){n=this.mParameters&&Object.keys(r.mParameters).some(function(e){return e[0]!=="$"||e[1]==="$"});if(n){return o}return e.getBinding().fetchIfChildCanUseCache(e,r.sPath,o).then(function(e){return e?undefined:o})}if(this.mParameters&&Object.keys(this.mParameters).length){return o}return o.then(function(e){return Object.keys(e).length===0?undefined:e})};u.prototype.fetchResourcePath=function(n){var o,r,i,s=this;if(!this.bRelative){return t.resolve(this.sPath.slice(1))}n=n||this.oContext;if(!n){return t.resolve()}r=n.getPath();o=n.fetchCanonicalPath&&(this.mParameters&&this.mParameters["$$canonicalPath"]||h.test(r));i=o?n.fetchCanonicalPath():t.resolve(r);return i.then(function(t){return e.buildPath(t,s.sPath).slice(1)})};u.prototype.getGroupId=function(){return this.sGroupId||this.bRelative&&this.oContext&&this.oContext.getGroupId&&this.oContext.getGroupId()||this.oModel.getGroupId()};u.prototype.getRelativePath=function(e){var t,n;if(e[0]==="/"){n=this.oModel.resolve(this.sPath,this.oContext);if(e.indexOf(n)===0){t=n}else if(this.oReturnValueContext&&e.indexOf(this.oReturnValueContext.getPath())===0){t=this.oReturnValueContext.getPath()}else{return undefined}e=e.slice(t.length);if(e[0]==="/"){e=e.slice(1)}}return e};u.prototype.getRootBinding=function(){if(this.bRelative&&this.oContext&&this.oContext.getBinding){return this.oContext.getBinding().getRootBinding()}return this.bRelative&&!this.oContext?undefined:this};u.prototype.getRootBindingResumePromise=function(){var e=this.getRootBinding();return e&&e.getResumePromise()||t.resolve()};u.prototype.getUpdateGroupId=function(){return this.sUpdateGroupId||this.bRelative&&this.oContext&&this.oContext.getUpdateGroupId&&this.oContext.getUpdateGroupId()||this.oModel.getUpdateGroupId()};u.prototype.hasPendingChanges=function(){return this.hasPendingChangesForPath("")||this.hasPendingChangesInDependents()};u.prototype.hasPendingChangesForPath=function(e){var t=this,n=this.withCache(function(e,t){return e.hasPendingChangesForPath(t)},e).catch(function(e){t.oModel.reportError("Error in hasPendingChangesForPath",a,e);return false});return n.isFulfilled()?n.getResult():false};u.prototype.hasPendingChangesInCaches=function(e){var t=this;if(!this.mCacheByResourcePath){return false}return Object.keys(this.mCacheByResourcePath).some(function(n){var o=t.mCacheByResourcePath[n];return o.$deepResourcePath.startsWith(e)&&o.hasPendingChangesForPath("")})};u.prototype.isInitial=function(){throw new Error("Unsupported operation: isInitial")};u.prototype.isRoot=function(){return!this.bRelative||this.oContext&&!this.oContext.getBinding};u.prototype.isRootBindingSuspended=function(){var e=this.getRootBinding();return e&&e.isSuspended()};u.prototype.lockGroup=function(e,t){return this.oModel.lockGroup(e,t,this)};u.prototype.refresh=function(e){if(!this.isRoot()){throw new Error("Refresh on this binding is not supported")}if(this.hasPendingChanges()){throw new Error("Cannot refresh due to pending changes")}this.oModel.checkGroupId(e);this.refreshInternal("",e,true).catch(function(){})};u.prototype.removeCachesAndMessages=function(e){var t=this.oModel,n=t.resolve(this.sPath,this.oContext),o=this;if(n){t.reportBoundMessages(n.slice(1),{})}if(this.mCacheByResourcePath){Object.keys(this.mCacheByResourcePath).forEach(function(n){var r=o.mCacheByResourcePath[n];if(r.$deepResourcePath.startsWith(e)){t.reportBoundMessages(r.$deepResourcePath,{});delete o.mCacheByResourcePath[n]}})}};u.prototype.resetChanges=function(){this.checkSuspended();this.resetChangesForPath("");this.resetChangesInDependents();this.resetInvalidDataState()};u.prototype.resetChangesForPath=function(e){var t=this.withCache(function(e,t){e.resetChangesForPath(t)},e),n=this;t.catch(function(e){n.oModel.reportError("Error in resetChangesForPath",a,e)});if(t.isRejected()){throw t.getResult()}};u.prototype.resetInvalidDataState=function(){};u.prototype.setResumeChangeReason=function(e){if(s.indexOf(e)>s.indexOf(this.sResumeChangeReason)){this.sResumeChangeReason=e}};u.prototype.toString=function(){return this.getMetadata().getName()+": "+(this.bRelative?this.oContext+"|":"")+this.sPath};u.prototype.withCache=function(t,n){var o,r=this;n=n||"";return this.oCachePromise.then(function(i){if(i){o=r.getRelativePath(n);if(o!==undefined){return t(i,o,r)}}else if(r.oOperation){return undefined}if(r.oContext&&r.oContext.withCache){return r.oContext.withCache(t,n[0]==="/"?n:e.buildPath(r.sPath,n))}return undefined})};function c(e){if(this){u.apply(this,arguments)}else{i.extend(e,u.prototype)}}c.prototype.destroy=u.prototype.destroy;return c},false);