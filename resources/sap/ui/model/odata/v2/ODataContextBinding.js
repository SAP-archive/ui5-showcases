/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/model/Context","sap/ui/model/ContextBinding","sap/ui/model/ChangeReason","sap/ui/thirdparty/jquery"],function(e,t,i,n){"use strict";var o=t.extend("sap.ui.model.odata.v2.ODataContextBinding",{constructor:function(e,i,o,s,r){t.call(this,e,i,o,s,r);this.sRefreshGroupId=undefined;this.bPendingRequest=false;this.mParameters=n.extend(true,{},this.mParameters);this.bCreatePreliminaryContext=this.mParameters.createPreliminaryContext||e.bPreliminaryContext;this.bUsePreliminaryContext=this.mParameters.usePreliminaryContext||e.bPreliminaryContext;this.mParameters.createPreliminaryContext=this.bCreatePreliminaryContext;this.mParameters.usePreliminaryContext=this.bUsePreliminaryContext;this.bPendingRequest=false}});o.prototype.initialize=function(){var e=this,t,n=this.isRelative()&&this.oContext&&this.oContext.bCreated,o=this.oContext&&this.oContext.isPreliminary(),s;if(!this.oModel.oMetadata.isLoaded()||!this.bInitial){return}this.bInitial=false;if(o&&!this.bUsePreliminaryContext){return}t=this.oModel.resolve(this.sPath,this.oContext);if(!t||n){this.oElementContext=null;this._fireChange({reason:i.Context});return}s=this.oModel._isReloadNeeded(t,this.mParameters);if(s){this.fireDataRequested();this.bPendingRequest=true}var r=this.oModel.createBindingContext(this.sPath,this.oContext,this.mParameters,function(t){var n;if(e.bCreatePreliminaryContext&&t&&e.oElementContext&&e.oElementContext.isPreliminary()){e.oElementContext.setPreliminary(false);e.oModel._updateContext(e.oElementContext,t.getPath());e._fireChange({reason:i.Context},false,true)}else if(!t||t!==e.oElementContext){e.oElementContext=t;e._fireChange({reason:i.Context})}if(s){if(e.oElementContext){n=e.oElementContext.getObject(e.mParameters)}e.oModel.callAfterUpdate(function(){e.fireDataReceived({data:n})});e.bPendingRequest=false}},s);if(r){if(this.bCreatePreliminaryContext&&this.oElementContext!==r){r.setPreliminary(true);this.oElementContext=r;this.oModel.oMetadata.loaded().then(function(){this._fireChange({reason:i.Context})}.bind(this))}}else if(this.oContext){this.oElementContext=null;this._fireChange({reason:i.Context})}};o.prototype.checkUpdate=function(e){var t,o=this.oContext&&this.oContext.isPreliminary();if(this.bInitial||this.bPendingRequest){return}if(this.oContext&&this.oContext.isUpdated()){this.setContext(this.oContext);return}if(o&&!this.bUsePreliminaryContext){return}if(!this._mParameters&&this.mParameters.createPreliminaryContext){this._mParameters=n.extend({},this.mParameters);delete this._mParameters.usePreliminaryContext;delete this._mParameters.createPreliminaryContext}t=this.oModel.createBindingContext(this.sPath,this.oContext,this._mParameters);if(t!==undefined&&t!==this.oElementContext){this.oElementContext=t;this._fireChange({reason:i.Context})}};o.prototype.refresh=function(e,t){if(typeof e==="string"){t=e;e=false}this.sRefreshGroupId=t;this._refresh(e);this.sRefreshGroupId=undefined};o.prototype._refresh=function(e,t){var o=this,s,r,a,h=false,l=this.mParameters,C=this.isRelative()&&this.oContext&&this.oContext.bCreated,m=this.oModel.resolve(this.sPath,this.oContext),x;if(this.bInitial||C){return}if(t){a=this.oModel._getObject(this.sPath,this.oContext);if(a){r=this.oModel._getKey(a);if(r in t){h=true}}}else{h=true}if(e||h){if(m){this.fireDataRequested();this.bPendingRequest=true}if(this.sRefreshGroupId){l=n.extend({},this.mParameters);l.groupId=this.sRefreshGroupId}var f=this.oModel.createBindingContext(this.sPath,this.oContext,l,function(t){if(o.bCreatePreliminaryContext&&t&&o.oElementContext&&o.oElementContext.isPreliminary()){o.oElementContext.setPreliminary(false);o.oModel._updateContext(o.oElementContext,t.getPath());o._fireChange({reason:i.Context},false,true)}else if(o.oElementContext!==t||e){o.oElementContext=t;o._fireChange({reason:i.Context},e)}if(o.oElementContext){s=o.oElementContext.getObject(o.mParameters)}if(m){o.oModel.callAfterUpdate(function(){o.fireDataReceived({data:s})});o.bPendingRequest=false}},true);if(f&&this.bCreatePreliminaryContext){if(this.oElementContext!==f||e){f.setPreliminary(true);this.oElementContext=f;x=this.oElementContext.sPath;this.oModel._updateContext(this.oElementContext,m);this._fireChange({reason:i.Context},e);this.oModel._updateContext(this.oElementContext,x)}}}};o.prototype.setContext=function(t){var n=this,o,s,o,r=t&&t.bCreated,a=t&&t.isPreliminary(),h=t&&t.isRefreshForced(),l=t&&t.isUpdated(),C,m;if(this.bInitial||!this.isRelative()){return}if(a&&!this.bUsePreliminaryContext){return}if(l&&this.bUsePreliminaryContext){this._fireChange({reason:i.Context});return}if(e.hasChanged(this.oContext,t)){this.oContext=t;s=this.oModel.resolve(this.sPath,this.oContext);if(!s||r){if(this.oElementContext!==null){this.oElementContext=null;this._fireChange({reason:i.Context})}return}o=this.oModel._getObject(this.sPath,this.oContext);m=h||this.oModel._isReloadNeeded(s,this.mParameters);if(s&&m){this.fireDataRequested();this.bPendingRequest=true}var t=this.oModel.createBindingContext(this.sPath,this.oContext,this.mParameters,function(e){if(n.bCreatePreliminaryContext&&e&&n.oElementContext&&n.oElementContext.isPreliminary()){n.oElementContext.setPreliminary(false);n.oModel._updateContext(n.oElementContext,e.getPath());n._fireChange({reason:i.Context},false,true)}else if(n.oElementContext!==e||h){n.oElementContext=e;n._fireChange({reason:i.Context},h)}if(s&&m){if(n.oElementContext){o=n.oElementContext.getObject(n.mParameters)}n.oModel.callAfterUpdate(function(){n.fireDataReceived({data:o})});n.bPendingRequest=false}},m);if(t){if(this.bCreatePreliminaryContext){t.setPreliminary(true);this.oElementContext=t;C=this.oElementContext.sPath;this.oModel._updateContext(this.oElementContext,s);this._fireChange({reason:i.Context},h);this.oModel._updateContext(this.oElementContext,C)}}else if(this.oContext&&this.oElementContext!==null){this.oElementContext=null;this._fireChange({reason:i.Context})}}};o.prototype._fireChange=function(e,i,n){if(this.oElementContext){this.oElementContext.setForceRefresh(i);this.oElementContext.setUpdated(n)}t.prototype._fireChange.call(this,e);if(this.oElementContext){this.oElementContext.setForceRefresh(false);this.oElementContext.setUpdated(false)}};return o});