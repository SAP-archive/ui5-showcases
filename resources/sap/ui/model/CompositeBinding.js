/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/DataType","./BindingMode","./ChangeReason","./PropertyBinding","./CompositeType","./CompositeDataState","sap/ui/base/SyncPromise","sap/base/util/deepEqual","sap/base/assert","sap/base/Log"],function(t,e,a,n,i,s,r,u,o,h){"use strict";var l=n.extend("sap.ui.model.CompositeBinding",{constructor:function(t,e,a){n.apply(this,[null,""]);this.aBindings=t;this.aValues=null;this.bRawValues=e;this.bPreventUpdate=false;this.bInternalValues=a},metadata:{publicMethods:["getBindings","attachChange","detachChange"]}});l.prototype.getPath=function(){o(null,"Composite Binding has no path!");return null};l.prototype.getModel=function(){o(null,"Composite Binding has no model!");return null};l.prototype.getContext=function(){o(null,"Composite Binding has no context!");return null};l.prototype.isResolved=function(){return this.aBindings.every(function(t){return t.isResolved()})};l.prototype.setType=function(t,e){if(t&&!(t instanceof i)){throw new Error("Only CompositeType can be used as type for composite bindings!")}n.prototype.setType.apply(this,arguments);if(this.oType){this.bRawValues=this.oType.getUseRawValues();this.bInternalValues=this.oType.getUseInternalValues();if(this.bRawValues&&this.bInternalValues){throw new Error(this.oType+" has both 'bUseRawValues' & 'bUseInternalValues' set to true. Only one of them is allowed to be true")}}};l.prototype.setContext=function(t){this.aBindings.forEach(function(e){if(!t||e.updateRequired(t.getModel())){e.setContext(t)}})};l.prototype.setValue=function(t){if(this.bSuspended){return}this.aBindings.forEach(function(e,a){var n=t[a];if(n!==undefined){e.setValue(n)}});this.getDataState().setValue(this.getValue())};l.prototype.getValue=function(){return this.aBindings.map(function(t){return t.getValue()})};l.prototype.getOriginalValue=function(){return this.aBindings.map(function(t){return t.getDataState().getOriginalValue()})};l.prototype.getExternalValue=function(){var e=[],a,n;switch(this.sInternalType){case"raw":return this.getRawValue();case"internal":return this.getInternalValue();default:a=this.sInternalType&&t.getType(this.sInternalType);e=this.getCurrentValues();if(this.fnFormatter){n=this.fnFormatter.apply(this,e)}else if(this.oType){n=this.oType.formatValue(e,this.sInternalType)}else if(a instanceof t&&a.isArrayType()){n=e}else if(e.length>1){n=e.join(" ")}else{n=e[0]}return n}};l.prototype.setExternalValue=function(e){var a,n,i,s=this;if(this.sInternalType==="raw"){this.setRawValue(e);return}else if(this.sInternalType==="internal"){this.setInternalValue(e);return}a=this.sInternalType&&t.getType(this.sInternalType);if(this.fnFormatter){h.warning("Tried to use twoway binding, but a formatter function is used");return}n=this.getDataState();if(this.oType){i=r.resolve().then(function(){var t;if(s.oType.getParseWithValues()){t=s.getCurrentValues()}return s.oType.parseValue(e,s.sInternalType,t)}).then(function(t){var e=s.getValidateValues(t);return r.all([t,s.oType.validateValue(e)])}).then(function(t){return t[0]}).catch(function(t){n.setInvalidValue(e);s.checkDataState();throw t})}else if(Array.isArray(e)&&a instanceof t&&a.isArrayType()){i=r.resolve(e)}else if(typeof e=="string"){i=r.resolve(e.split(" "))}else{i=r.resolve([e])}return i.then(function(t){s.aBindings.forEach(function(a,n){e=t[n];if(e!==undefined){if(s.bRawValues){a.setRawValue(e)}else if(s.bInternalValues){a.setInternalValue(e)}else{a.setExternalValue(e)}}});n.setValue(s.getValue());n.setInvalidValue(undefined)}).unwrap()};l.prototype.getInternalValue=function(){return this.aBindings.map(function(t){return t.getInternalValue()})};l.prototype.setInternalValue=function(t){var e=this.getDataState(),a,n=this;if(this.oType){a=r.resolve(t).then(function(t){if(!n.bInternalValues){t=n.aBindings.map(function(e,a){return e._internalToRaw(t[a])});if(!n.bRawValues){t=n.aBindings.map(function(e,a){return e._rawToExternal(t[a])})}}return n.oType.validateValue(t)}).then(function(){return t}).catch(function(a){e.setInvalidValue(t);n.checkDataState();throw a})}else{a=r.resolve(t)}return a.then(function(){n.aBindings.forEach(function(e,a){var n=t[a];if(n!==undefined){e.setInternalValue(n)}});e.setValue(n.getValue());e.setInvalidValue(undefined)}).unwrap()};l.prototype.getRawValue=function(){return this.aBindings.map(function(t){return t.getRawValue()})};l.prototype.setRawValue=function(t){var e=this.getDataState(),a,n=this;if(this.oType){a=r.resolve(t).then(function(t){if(!n.bRawValues){if(n.bInternalValues){t=n.aBindings.map(function(e,a){return e._rawToInternal(t[a])})}else{t=n.aBindings.map(function(e,a){return e._rawToExternal(t[a])})}}return n.oType.validateValue(t)}).then(function(){return t}).catch(function(a){e.setInvalidValue(t);n.checkDataState();throw a})}else{a=r.resolve(t)}return a.then(function(){n.aBindings.forEach(function(e,a){var n=t[a];if(n!==undefined){e.setRawValue(n)}});e.setValue(n.getValue());e.setInvalidValue(undefined)}).unwrap()};l.prototype.getCurrentValues=function(){if(this.bRawValues){return this.getRawValue()}else if(this.bInternalValues){return this.getInternalValue()}else{return this.aBindings.map(function(t){return t.getExternalValue()})}};l.prototype.getValidateValues=function(t){var e,a,n=t;a=this.aBindings.some(function(e,a){return t[a]===undefined});if(a){e=this.getCurrentValues();n=e.map(function(e,a){return t[a]===undefined?e:t[a]})}return n};l.prototype.getBindings=function(){return this.aBindings};l.prototype.hasValidation=function(){if(this.getType()){return true}var t=this.getBindings();for(var e=0;e<t.length;++e){if(t[e].hasValidation()){return true}}return false};l.prototype.attachChange=function(t,a){var n=this;this.fChangeHandler=function(t){if(n.bSuspended){return}var a=t.getSource();if(a.getBindingMode()==e.OneTime){a.detachChange(n.fChangeHandler)}n.checkUpdate(true)};this.attachEvent("change",t,a);if(this.aBindings){this.aBindings.forEach(function(t){t.attachChange(n.fChangeHandler)})}};l.prototype.detachChange=function(t,e){var a=this;this.detachEvent("change",t,e);if(this.aBindings){this.aBindings.forEach(function(t){t.detachChange(a.fChangeHandler)})}};l.prototype.attachDataStateChange=function(t,a){var n=this;this.fDataStateChangeHandler=function(t){var a=t.getSource();if(a.getBindingMode()==e.OneTime){a.detachDataStateChange(n.fChangeHandler)}n.checkDataState()};this.attachEvent("DataStateChange",t,a);if(this.aBindings){this.aBindings.forEach(function(t){t.attachEvent("DataStateChange",n.fDataStateChangeHandler)})}};l.prototype.detachDataStateChange=function(t,e){var a=this;this.detachEvent("DataStateChange",t,e);if(this.aBindings){this.aBindings.forEach(function(t){t.detachEvent("DataStateChange",a.fDataStateChangeHandler)})}};l.prototype.attachAggregatedDataStateChange=function(t,a){var n=this;if(!this.fDataStateChangeHandler){this.fDataStateChangeHandler=function(t){var a=t.getSource();if(a.getBindingMode()==e.OneTime){a.detachDataStateChange(n.fChangeHandler)}n.checkDataState()}}this.attachEvent("AggregatedDataStateChange",t,a);if(this.aBindings){this.aBindings.forEach(function(t){t.attachEvent("DataStateChange",n.fDataStateChangeHandler)})}};l.prototype.detachAggregatedDataStateChange=function(t,e){var a=this;this.detachEvent("AggregatedDataStateChange",t,e);if(this.aBindings){this.aBindings.forEach(function(t){t.detachEvent("DataStateChange",a.fDataStateChangeHandler)})}};l.prototype.updateRequired=function(t){var e=false;this.aBindings.forEach(function(a){e=e||a.updateRequired(t)});return e};l.prototype.initialize=function(){this.bPreventUpdate=true;if(this.aBindings){this.aBindings.forEach(function(t){t.initialize()})}this.bPreventUpdate=false;if(!this.bSuspended){this.checkUpdate(true)}return this};l.prototype.getDataState=function(){if(!this.oDataState){this.oDataState=new s(this.aBindings.map(function(t){return t.getDataState()}))}return this.oDataState};l.prototype.suspend=function(){this.bSuspended=true;this.aBindings.forEach(function(t){t.suspend()})};l.prototype.resume=function(){this.aBindings.forEach(function(t){t.resume()});this.bSuspended=false;this.checkUpdate(true)};l.prototype.checkUpdate=function(t){var e=false;if(this.bPreventUpdate||this.bSuspended&&!t){return}var n=this.getDataState();var i=this.getOriginalValue();if(t||!u(i,this.aOriginalValues)){this.aOriginalValues=i;n.setOriginalValue(i);e=true}var s=this.getValue();if(!u(s,this.aValues)||t){this.aValues=s;n.setValue(s);this._fireChange({reason:a.Change});e=true}if(e){this.checkDataState()}};return l});