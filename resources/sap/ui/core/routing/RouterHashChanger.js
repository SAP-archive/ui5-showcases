/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./HashChangerBase","sap/base/Log"],function(e,t){"use strict";var h=e.extend("sap.ui.core.routing.RouterHashChanger",{constructor:function(t){if(!t||!t.parent){throw new Error("sap.ui.core.routing.RouterHashChanger can't be instantiated without a parent")}this.parent=t.parent;this.hash=t.hash||"";this.subHashMap=t.subHashMap;this.key=t.key||"";e.apply(this)}});h.prototype.init=function(){this.parent.init()};h.prototype._generatePrefixedKey=function(e){return this.key?this.key+"-"+e:e};h.prototype.createSubHashChanger=function(e){this.children=this.children||{};var t=this._generatePrefixedKey(e);if(this.children[t]){return this.children[t]}var i=new h({key:t,parent:this,subHashMap:this.subHashMap,hash:this.subHashMap&&this.subHashMap[t]||""});i.attachEvent("hashSet",this._onChildHashChanged.bind(this,t));i.attachEvent("hashReplaced",this._onChildHashChanged.bind(this,t));this.children[t]=i;return i};h.prototype.fireHashChanged=function(e,t,h){var i,s=this.hash;this.hash=e;this.subHashMap=t;if(!h){this.fireEvent("hashChanged",{newHash:e,oldHash:s})}if(this.children){i=Object.keys(this.children);i.forEach(function(e){var i=t[e]===undefined?"":t[e];this.children[e].fireHashChanged(i,t,h)}.bind(this))}};h.prototype._onChildHashChanged=function(e,t){var h=t.getParameter("key")||e;this.fireEvent(t.getId(),{hash:t.getParameter("hash"),key:h,deletePrefix:t.getParameter("deletePrefix")})};h.prototype._hasRouterAttached=function(){return this.hasListeners("hashChanged")};h.prototype._collectActiveDescendantPrefix=function(){if(this.children){var e=Object.keys(this.children);return e.reduce(function(e,t){var h=this.children[t];if(h._hasRouterAttached()){e.push(t);Array.prototype.push.apply(e,h._collectActiveDescendantPrefix())}return e}.bind(this),[])}else{return[]}};h.prototype.getHash=function(){return this.hash};h.prototype.setHash=function(e){if(this._hasRouterAttached()){var h=this._collectActiveDescendantPrefix();this.fireEvent("hashSet",{hash:e,deletePrefix:h})}else{t.warning("The function setHash is called on a router which isn't matched within the last browser hashChange event. The call is ignored.")}};h.prototype.replaceHash=function(e){if(this._hasRouterAttached()){var h=this._collectActiveDescendantPrefix();this.fireEvent("hashReplaced",{hash:e,deletePrefix:h})}else{t.warning("The function replaceHash is called on a router which isn't matched within the last browser hashChange event. The call is ignored.")}};h.prototype.destroy=function(){this.parent.deregisterRouterHashChanger(this);if(this.children){Object.keys(this.children).forEach(function(e){var t=this.children[e];t.destroy()}.bind(this));delete this.children}delete this.hash;delete this.subHashMap;delete this.parent;delete this.key;e.prototype.destroy.apply(this,arguments)};h.prototype.deregisterRouterHashChanger=function(e){if(this.children){Object.keys(this.children).some(function(t){var h=this.children[t];if(h===e){delete this.children[t];return true}}.bind(this))}};return h});