/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/Metadata","sap/ui/core/CustomData","sap/ui/base/ManagedObjectObserver","./AnchorBar","sap/m/Button","sap/m/MenuButton","sap/m/Menu","sap/m/MenuItem","sap/ui/core/IconPool"],function(t,e,n,o,i,a,r,s,u,c){"use strict";var g=e.createClass("sap.uxap._helpers.AB",{constructor:function(t){this._oObjectPageLayout=t;this._iScrollDuration=t._iScrollToSectionDuration;this._iFocusMoveDelay=this._iScrollDuration-100;this._oObserver=new o(this._proxyStateChanges.bind(this));this._aMenusWithAttachPressHandler=[]}});g.prototype.getObjectPageLayout=function(){return this._oObjectPageLayout};g.prototype._proxyStateChanges=function(t){var e=t.object,n=this._findExistingClone(e),o=t.name,i=t.current,a="set"+h(o);if(n){n[a].call(n,i)}};g.prototype._findExistingClone=function(t){var e,n=t.getId()+"-__clone",o=this._getAnchorBar(),i=o.getContent();i.some(function(t){if(t.getId().indexOf(n)===0){e=t;return true}});return e};g.prototype._getAnchorBar=function(){var t=this.getObjectPageLayout(),e=t.getAggregation("_anchorBar");if(!e){e=new i({id:t.getId()+"-anchBar",showPopover:t.getShowAnchorBarPopover(),backgroundDesign:t.getBackgroundDesignAnchorBar()});this.getObjectPageLayout().setAggregation("_anchorBar",e,true)}return e};g.prototype._buildAnchorBar=function(){var e=this.getObjectPageLayout().getSections()||[],o=this._getAnchorBar(),i=t.proxy(o._handleDirectScroll,o),a,c,g,h;if(o&&this.getObjectPageLayout().getShowAnchorBar()){o._resetControl();this._oObserver.disconnect();e.forEach(function(t){if(!t.getVisible()||!t._getInternalVisible()){return}var e,l=t.getSubSections()||[];e=this._buildAnchorBarButton(t,true);if(e){o.addContent(e);if(e instanceof r){var d=new s({}),f=sap.ui.getCore().getLibraryResourceBundle("sap.uxap");e.enhanceAccessibilityState=function(t,e){var n=o.getContent(),i=n.indexOf(t.getParent());if(i!==-1){e.role="menuitemradio";e.roledescription=f.getText("ANCHOR_BAR_MENUITEM");e.setsize=n.length;e.posinset=i+1}};d._setCustomEnhanceAccStateFunction(function(t,e){e.controls=t.data("sectionId")});e.setMenu(d)}l.forEach(function(t){if(!t.getVisible()||!t._getInternalVisible()){return}var s=this._buildAnchorBarButton(t,false);if(s){o.addContent(s)}if(e instanceof r){h=t.getCustomAnchorBarButton();if(h){a=h.getText();c=h.getIcon()}else{a=t._getInternalTitle()||t.getTitle();c=""}g=new u({text:a,icon:c});g.addCustomData(new n({key:"sectionId",value:t.getId()}));g.attachPress(i);e.getMenu().addItem(g)}},this)}},this)}};g.prototype._moveFocusOnSection=function(t){var e=t.data(),n=sap.ui.getCore().byId(e.sectionId),o=this.getObjectPageLayout(),i=n.isA("sap.uxap.ObjectPageSubSection"),a=n&&!o.getUseIconTabBar()||o.getUseIconTabBar()&&i,r=this._iFocusMoveDelay;if(a){setTimeout(n.$()["focus"].bind(n.$()),r)}if(o.getUseIconTabBar()&&i){var s={onAfterRendering:function(){this.removeEventDelegate(s);setTimeout(this.$()["focus"].bind(this.$()),r)}.bind(n)};n.addEventDelegate(s)}};g.prototype._instantiateAnchorBarButton=function(t,e,n){var o=t?new r({type:"Transparent",buttonMode:"Split",useDefaultActionOnly:true,ariaDescribedBy:e,id:n}):new a({ariaDescribedBy:e,id:n});return o};g.prototype._buildAnchorBarButton=function(e,o){var i=null,a=this.getObjectPageLayout(),r,s=this._getAnchorBar(),u,c,g,h=e.getAggregation("subSections"),l=t.proxy(s._handleDirectScroll,s);if(e.getVisible()&&e._getInternalVisible()){r=e.getCustomAnchorBarButton();if(!r){u=s.getId()+"-"+e.getId()+"-anchor";if(o){if(h&&h.length>1){g=h.filter(function(t){return t.getVisible()&&t._getInternalVisible()}).length}}c=o&&g>1&&s.getShowPopover();if(c){i=this._instantiateAnchorBarButton(true,e,u);i.attachDefaultAction(l);i._getButtonControl().attachPress(function(){this.getParent().focus()});i._getButtonControl().attachArrowPress(function(){var t=i._getButtonControl();if(this._aMenusWithAttachPressHandler[t.getId()]){return}i.getMenu().attachItemSelected(function(t){this._moveFocusOnSection(t.getParameter("item"))},this);this._aMenusWithAttachPressHandler[t.getId()]=true},this);i.addCustomData(new n({key:"bHasSubMenu",value:true}))}else{i=this._instantiateAnchorBarButton(false,e,u);i.attachPress(l);i.attachPress(function(t){this._moveFocusOnSection(t.getSource())},this)}var d=e._getInternalTitle()!=""?e._getInternalTitle():e.getTitle();i.setText(d)}else{i=r.clone();i.attachPress(l);i.attachPress(function(t){this._moveFocusOnSection(t.getSource())},this);this._oObserver.observe(r,{properties:true})}a._oSectionInfo[e.getId()].buttonId=i.getId();i.addCustomData(new n({key:"sectionId",value:e.getId()}));i.addCustomData(new n({key:"bTitleVisible",value:e._getInternalTitleVisible()}));if(!o){i.addCustomData(new n({key:"secondLevel",value:true}))}}return i};function h(t){return t.substring(0,1).toUpperCase()+t.substring(1)}return g},false);