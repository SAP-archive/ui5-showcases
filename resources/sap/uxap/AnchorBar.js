/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/m/Button","sap/m/MenuButton","sap/m/library","sap/m/Toolbar","sap/ui/core/IconPool","sap/ui/core/Item","sap/ui/core/ResizeHandler","sap/ui/core/delegate/ScrollEnablement","sap/ui/layout/HorizontalLayout","sap/ui/Device","sap/ui/core/CustomData","sap/ui/core/Control","./HierarchicalSelect","./library","sap/uxap/AnchorBarRenderer","sap/base/Log","sap/ui/events/KeyCodes","sap/ui/events/F6Navigation"],function(t,e,o,i,r,s,n,a,c,l,h,u,f,p,d,g,_,S,y){"use strict";var A=i.SelectType;var b=r.extend("sap.uxap.AnchorBar",{metadata:{library:"sap.uxap",properties:{showPopover:{type:"boolean",defaultValue:true},upperCase:{type:"boolean",defaultValue:false},backgroundDesign:{type:"sap.m.BackgroundDesign",group:"Appearance"}},associations:{selectedButton:{type:"sap.m.Button",multiple:false}},aggregations:{_select:{type:"sap.uxap.HierarchicalSelect",multiple:false,visibility:"hidden"},_scrollArrowLeft:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},_scrollArrowRight:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}}}});b.prototype.init=function(){if(r.prototype.init){r.prototype.init.call(this)}this.addStyleClass("sapUxAPAnchorBar");this._oPressHandlers={};this._oSectionInfo={};this._oScroller=null;this._sSelectedKey=null;this._bRtl=sap.ui.getCore().getConfiguration().getRTL();this._bRtlScenario=this._bRtl&&!h.browser.msie;this._bHasButtonsBar=h.system.tablet||h.system.desktop;this.oLibraryResourceBundleOP=sap.ui.getCore().getLibraryResourceBundle("sap.uxap");this._oSelect=this._getHierarchicalSelect();if(this._bHasButtonsBar){this._oScroller=new c(this,this.getId()+"-scroll",{horizontal:true,vertical:false,nonTouchScrolling:true});this._iREMSize=0;this._iTolerance=0;this._iOffset=0;this._sResizeListenerId=undefined}this.setDesign("Transparent")};b.SCROLL_STEP=250;b.SCROLL_DURATION=500;b.DOM_CALC_DELAY=200;b.prototype.setSelectedButton=function(t){var e=this.getSelectedButton(),o,i=this._oSelect.getItems(),r=i.length>0;if(typeof t==="string"){t=sap.ui.getCore().byId(t)}if(t){if(t.getId()===e){return this}var s=t.data("sectionId");this._sSelectedKey=s;if(s&&r){this._oSelect.setSelectedKey(s)}if(this._bHasButtonsBar){o=sap.ui.getCore().byId(e);this._toggleSelectionStyleClass(o,false);this._toggleSelectionStyleClass(t,true);if(s){this.scrollToSection(s,b.SCROLL_DURATION)}this._setAnchorButtonsTabFocusValues(t)}this.setAssociation("selectedButton",t,true)}return this};b.prototype.setShowPopover=function(t,e){if(this.getShowPopover()===t){return this}return this.setProperty("showPopover",t,true)};b.prototype.setBackgroundDesign=function(t){var e=this.getBackgroundDesign(),o=this.$(),i="sapUxAPAnchorBar";if(e===t){return this}this.setProperty("backgroundDesign",t,true);if(o.length){o.removeClass(i+e);o.addClass(i+t)}return this};b.prototype.getSelectedSection=function(){var t=this.getSelectedButton();if(t&&typeof t==="string"){t=sap.ui.getCore().byId(t)}if(t&&t instanceof e&&t.data("sectionId")){return sap.ui.getCore().byId(t.data("sectionId"))}return null};b.prototype.onBeforeRendering=function(){var e=this.getBackgroundDesign();if(this._bHasButtonsBar){this._iREMSize=parseInt(t("body").css("font-size"));this._iTolerance=this._iREMSize*1;this._iOffset=this._iREMSize*3}if(r.prototype.onBeforeRendering){r.prototype.onBeforeRendering.call(this)}var o=this.getContent()||[],i=this.getUpperCase();this._oSelect.removeAllItems();this._oSelect.setUpperCase(i);this.toggleStyleClass("sapUxAPAnchorBarUpperCase",i);if(e){this.addStyleClass("sapUxAPAnchorBar"+e)}o.forEach(function(t){this._createSelectItem(t)},this);if(o.length>0&&this._sSelectedKey){this._oSelect.setSelectedKey(this._sSelectedKey)}};b.prototype.addContent=function(t,e){t.addStyleClass("sapUxAPAnchorBarButton");t.removeAllAriaDescribedBy();if(this._bHasButtonsBar&&(t.data("secondLevel")===true||t.data("secondLevel")==="true")){t.attachPress(this._handleDirectScroll,this)}return this.addAggregation("content",t,e)};b.prototype._createSelectItem=function(t){var e=t.data("secondLevel")===true||t.data("secondLevel")==="true";if(t.getText().trim()!=""&&(!e||t.data("bTitleVisible")===true)){var o=new n({key:t.data("sectionId"),text:t.getText(),customData:[new u({key:"secondLevel",value:t.data("secondLevel")})]});this._oSelect.addItem(o)}if(e){this.removeContent(t);t.destroy()}};b.prototype._decorateSubMenuButtons=function(t){var e=t.getSource().getContent();e.forEach(function(t){t.$().attr("aria-controls",t.data("sectionId"))})};b.prototype._toggleSelectionStyleClass=function(t,e){if(t){t.toggleStyleClass("sapUxAPAnchorBarButtonSelected",e);if(t instanceof o){t._getButtonControl().$().attr("aria-checked",e)}else{t.$().attr("aria-checked",e)}}};b.prototype._handleDirectScroll=function(t){this._requestScrollToSection(t.getSource().data("sectionId"))};b.prototype._requestScrollToSection=function(t){var e=sap.ui.getCore().byId(t),o=e.getParent();if(this.getParent()instanceof d.ObjectPageLayout){var i=t;if(e instanceof d.ObjectPageSubSection&&o instanceof d.ObjectPageSection){i=o.getId()}this.getParent().setDirectScrollingToSection(i);this.getParent().scrollToSection(e.getId(),null,0,true)}if(e instanceof d.ObjectPageSubSection&&o instanceof d.ObjectPageSection){o.setAssociation("selectedSubSection",e,true)}};b.prototype._onSelectChange=function(t){var e=t.getParameter("selectedItem"),o;o=sap.ui.getCore().byId(e.getKey());if(o){this._requestScrollToSection(o.getId())}else{_.error("AnchorBar :: cannot find corresponding section",e.getKey())}};b.prototype._getHierarchicalSelect=function(){if(!this.getAggregation("_select")){this.setAggregation("_select",new p({width:"100%",icon:"sap-icon://slim-arrow-down",tooltip:this.oLibraryResourceBundleOP.getText("ANCHOR_BAR_OVERFLOW"),change:t.proxy(this._onSelectChange,this)}))}return this.getAggregation("_select")};b.prototype._createScrollArrow=function(t){var o,i,r,n,a,c=this,h=this.oLibraryResourceBundleOP.getText("TOOLTIP_OP_SCROLL_LEFT_ARROW"),u=this.oLibraryResourceBundleOP.getText("TOOLTIP_OP_SCROLL_RIGHT_ARROW");if(t){o=this.getId()+"-arrowScrollLeft";i="slim-arrow-left";r="anchorBarArrowLeft";n=this._bRtl?u:h}else{o=this.getId()+"-arrowScrollRight";i="slim-arrow-right";r="anchorBarArrowRight";n=this._bRtl?h:u}a=new e(o,{icon:s.getIconURI(i),type:"Transparent",press:function(e){e.preventDefault();c._handleScrollButtonTap(t)},tooltip:n});a.addEventDelegate({onAfterRendering:function(){if(sap.ui.getCore().getConfiguration().getTheme()!="sap_hcb"){this.$().attr("tabindex",-1)}},onThemeChanged:function(){if(sap.ui.getCore().getConfiguration().getTheme()=="sap_hcb"){this.$().removeAttr("tabindex")}else{this.$().attr("tabindex",-1)}}},a);return new l({content:[a]}).addStyleClass("anchorBarArrow").addStyleClass(r)};b.prototype._getScrollArrowLeft=function(){var t=this.getAggregation("_scrollArrowLeft");if(t){return t}else{t=this._createScrollArrow(true);this.setAggregation("_scrollArrowLeft",t);return t}};b.prototype._getScrollArrowRight=function(){var t=this.getAggregation("_scrollArrowRight");if(t){return t}else{t=this._createScrollArrow(false);this.setAggregation("_scrollArrowRight",t);return t}};b.prototype._applyHierarchicalSelectMode=function(){if(this._sHierarchicalSelectMode===g._AnchorBarHierarchicalSelectMode.Icon){this.$().find(".sapUxAPAnchorBarScrollContainer").show();this._oSelect.setWidth("auto");this._oSelect.setAutoAdjustWidth(true);this._oSelect.setType(A.IconOnly);this._computeBarSectionsInfo()}else{this.$().find(".sapUxAPAnchorBarScrollContainer").hide();this._oSelect.setWidth("100%");this._oSelect.setAutoAdjustWidth(false);this._oSelect.setType(A.Default)}this.$().toggleClass("sapUxAPAnchorBarOverflow",this._sHierarchicalSelectMode===g._AnchorBarHierarchicalSelectMode.Icon)};b.prototype._adjustSize=function(){var t=h.media.getCurrentRange(h.media.RANGESETS.SAP_STANDARD,this._getWidth(this)),e=d.Utilities.isPhoneScenario(t)?g._AnchorBarHierarchicalSelectMode.Text:g._AnchorBarHierarchicalSelectMode.Icon;if(e!==this._sHierarchicalSelectMode){this._sHierarchicalSelectMode=e;this._applyHierarchicalSelectMode()}if(this._sHierarchicalSelectMode===g._AnchorBarHierarchicalSelectMode.Icon){if(this._iMaxPosition<0){return}var o=this.$(),i=o.find(".sapUxAPAnchorBarScrollContainer"),r,s,n;n=i.width();if(this._bRtlScenario){if(h.browser.firefox){s=Math.abs(i.scrollLeft())+n<this._iMaxPosition-this._iTolerance;r=Math.abs(i.scrollLeft())>=this._iTolerance}else{s=Math.abs(i.scrollLeft())>=this._iTolerance;r=Math.abs(i.scrollLeft())+n<this._iMaxPosition-this._iTolerance}}else{s=i.scrollLeft()+n<this._iMaxPosition-this._iTolerance;r=i.scrollLeft()>=this._iTolerance}_.debug("AnchorBar :: scrolled at "+i.scrollLeft(),"scrollBegin ["+(r?"true":"false")+"] scrollEnd ["+(s?"true":"false")+"]");o.toggleClass("sapUxAPAnchorBarScrollLeft",r);o.toggleClass("sapUxAPAnchorBarScrollRight",s)}};b.prototype._handleScrollButtonTap=function(t){var e=!this._bRtlScenario&&t||this._bRtlScenario&&!t?-1:1;this._oScroller.scrollTo(this._iMaxPosition*e,0,b.SCROLL_DURATION*3)};b.prototype.scrollToSection=function(e,o){if(this._bHasButtonsBar){var i=h.media.getCurrentRange(h.media.RANGESETS.SAP_STANDARD,this._getWidth(this)),o=o||b.SCROLL_DURATION,r;if(!d.Utilities.isPhoneScenario(i)&&this._oSectionInfo[e]){if(this._bRtlScenario&&h.browser.firefox){r=this._oSectionInfo[e].scrollLeft+this._iOffset}else{r=this._oSectionInfo[e].scrollLeft-this._iOffset;if(r<0){r=0}}_.debug("AnchorBar :: scrolling to section "+e+" of "+r);if(this._sCurrentScrollId!=e){this._sCurrentScrollId=e;if(this._iCurrentScrollTimeout){clearTimeout(this._iCurrentScrollTimeout);t(document.getElementById(this.getId()+"-scroll")).parent().stop(true,false)}this._iCurrentScrollTimeout=setTimeout(function(){this._sCurrentScrollId=undefined;this._iCurrentScrollTimeout=undefined}.bind(this),o);this._oScroller.scrollTo(r,0,o)}}else{_.debug("AnchorBar :: no need to scroll to "+e)}}};b.prototype.getScrollDelegate=function(){return this._oScroller};b.PAGEUP_AND_PAGEDOWN_JUMP_SIZE=5;b.prototype.onsapright=function(t){t.preventDefault();var e;var o=this.getContent();o.forEach(function(o,i){if(t.target.id.indexOf(o.getId())>-1){e=i+1;return}});if(e&&o[e]){o[e].focus()}else if(o[o.length-1]){o[o.length-1].focus()}};b.prototype.onsapleft=function(t){t.preventDefault();var e;var o=this.getContent();o.forEach(function(o,i){if(t.target.id.indexOf(o.getId())>-1){e=i-1;return}});if(e&&o[e]){o[e].focus()}else if(o[0]){o[0].focus()}};b.prototype.onsapdown=function(t){t.preventDefault()};b.prototype.onsapup=function(t){t.preventDefault()};b.prototype.onsaphome=function(t){t.preventDefault();var e=this.getContent();e[0].focus()};b.prototype.onsapend=function(t){t.preventDefault();var e=this.getContent();e[e.length-1].focus()};b.prototype.onsappageup=function(t){this._handlePageUp(t)};b.prototype.onsappagedown=function(t){this._handlePageDown(t)};b.prototype._handlePageUp=function(t){t.preventDefault();var e;var o=this.getContent();o.forEach(function(o,i){if(t.target.id.indexOf(o.getId())>-1){e=i-(b.PAGEUP_AND_PAGEDOWN_JUMP_SIZE+1);return}});if(e&&o[e]){o[e].focus()}else if(o[0]){o[0].focus()}};b.prototype._handlePageDown=function(t){t.preventDefault();var e;var o=this.getContent();o.forEach(function(o,i){if(t.target.id.indexOf(o.getId())>-1){e=i+b.PAGEUP_AND_PAGEDOWN_JUMP_SIZE+1;return}});if(e&&o[e]){o[e].focus()}else if(o[o.length-1]){o[o.length-1].focus()}};b.prototype._setAnchorButtonsTabFocusValues=function(t){var e=this.getContent()||[],o,i="0",r="-1",s="tabIndex";e.forEach(function(e){o=e.getAggregation("_button")?e.getAggregation("_button").$():e.$();if(e.sId===(t&&t.sId)){o.attr(s,i)}else{o.attr(s,r)}})};b.prototype.onsapskipforward=function(t){this._handleGroupNavigation(t,false)};b.prototype._handleGroupNavigation=function(e,o){var i=t.Event("keydown"),r={},s=this.getParent(),n=s.getUseIconTabBar(),a=s.getSelectedSection(),c=s._getVisibleSections(),l=[this.getDomRef()],h=[];if(n){h=sap.ui.getCore().byId(a).getSubSections().map(function(t){return t.$().attr("tabindex",-1)[0]});l=l.concat(h)}else{c.forEach(function(t){h=t.getSubSections().map(function(t){return t.$().attr("tabindex",-1)[0]});l=l.concat(h)})}r.scope=l;e.preventDefault();this.$().focus();i.target=e.target;i.keyCode=S.F6;i.key="F6";i.shiftKey=o;y.handleF6GroupNavigation(i,r)};b.prototype.onAfterRendering=function(){var e,o=this._getHeadeTitleAriaLabelText();if(r.prototype.onAfterRendering){r.prototype.onAfterRendering.call(this)}e=sap.ui.getCore().byId(this.getSelectedButton());this._setAnchorButtonsTabFocusValues(e);this._iMaxPosition=-1;this._sResizeListenerId=a.register(this,t.proxy(this._adjustSize,this));this.$().find(".sapUxAPAnchorBarScrollContainer").scroll(t.proxy(this._onScroll,this));if(o){this.$().attr("aria-label",o)}if(e){this.setSelectedButton(e)}if(this._bHasButtonsBar){setTimeout(function(){if(this._sHierarchicalSelectMode===g._AnchorBarHierarchicalSelectMode.Icon){this._computeBarSectionsInfo()}this._adjustSize()}.bind(this),b.DOM_CALC_DELAY)}};b.prototype._onScroll=function(){if(!this._iCurrentSizeCheckTimeout){this._iCurrentSizeCheckTimeout=setTimeout(function(){this._iCurrentSizeCheckTimeout=undefined;this._adjustSize()}.bind(this),b.SCROLL_DURATION)}};b.prototype._computeBarSectionsInfo=function(){this._iMaxPosition=0;var t=this.getContent()||[];t.forEach(this._computeNextSectionInfo,this);if(this._bRtlScenario&&(h.browser.webkit||h.browser.firefox)){t.forEach(this._adjustNextSectionInfo,this);this._oScroller.scrollTo(this._iMaxPosition,0,0)}};b.prototype._computeNextSectionInfo=function(t){var e=t.isA("sap.m.MenuButton")?t._getButtonControl():t,o=t.hasStyleClass("sapUxAPAnchorBarButtonSelected");if(t.data("bHasSubMenu")){e.$().attr("aria-haspopup","true")}e.$().attr("aria-controls",t.data("sectionId")).attr("aria-checked",o);var i=t.$().outerWidth(true);this._oSectionInfo[t.data("sectionId")]={scrollLeft:this._iMaxPosition,width:i};this._iMaxPosition+=i};b.prototype._adjustNextSectionInfo=function(t){var e=this._oSectionInfo[t.data("sectionId")];if(h.browser.firefox){e.scrollLeft=-e.scrollLeft}else{e.scrollLeft=this._iMaxPosition-e.scrollLeft-e.width}};b.prototype._resetControl=function(){this.destroyAggregation("content",true);return this};b.prototype._getHeadeTitleAriaLabelText=function(){var t=this.getParent();if(t.isA("sap.uxap.ObjectPageLayout")){return t._getAriaLabelText("NAVTOOLBAR")}return null};b.prototype.enhanceAccessibilityState=function(t,e){var o=this.getContent(),i=o.indexOf(t);if(i!==-1){e.role="menuitemradio";e.roledescription=this.oLibraryResourceBundleOP.getText("ANCHOR_BAR_MENUITEM");e.setsize=o.length;e.posinset=i+1}};b.prototype.exit=function(){if(this._sResizeListenerId){a.deregister(this._sResizeListenerId);this._sResizeListenerId=null}if(this._oScroller){this._oScroller.destroy();this._oScroller=null}if(this.oLibraryResourceBundleOP){this.oLibraryResourceBundleOP=null}};b.prototype._getWidth=function(t){var e=t.getDomRef();return!(t instanceof f)?0:e&&e.offsetWidth||0};return b});