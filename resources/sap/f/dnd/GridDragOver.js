/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/thirdparty/jquery"],function(t,i){"use strict";var r=t.extend("sap.f.dnd.GridDragOver",{_iTimeoutBeforeDrop:200,_$indicator:i("<div class='sapUiDnDGridIndicator'></div>")});r.prototype.setCurrentContext=function(t,i,r){if(this._oDragControl===t&&this._oDropContainer===i&&this._sTargetAggregation===r){return this}if(this._oDragControl&&this._oDragControl!==t){this.endDrag()}this._oDragControl=t;this._oDropContainer=i;this._sTargetAggregation=r;this._mDragItemDimensions=this._getDimensions(t);this._bIsInSameContainer=t.getParent()===i;if(this._bIsInSameContainer){this._iDragFromIndex=i.indexOfAggregation(r,t)}else{this._iDragFromIndex=null}i.getAggregation(r).forEach(function(t){t.addStyleClass("sapUiDnDGridControl")});return this};r.prototype.handleDragOver=function(t){if(this._shouldFreeze(t.pageX,t.pageY)){return}var i=this._calculateDropPosition(t);if(!i){return}if(this._timeoutOnSamePosition(i)){if(i.targetControl===this._oDragControl){return}this._hideDraggedItem();this._showIndicator(i);this._freezeCurrentPosition(t.pageX,t.pageY)}};r.prototype.getSuggestedDropPosition=function(){return this._mLastDropPosition};r.prototype.endDrag=function(){this._$indicator.detach();this._showDraggedItem();this._iDragFromIndex=null;this._iDropPositionHoldStart=null;this._mLastDropPosition=null;this._mFreezePosition=null};r.prototype._showIndicator=function(t){var i=this._findContainingGridItem(t.targetControl),r=i||t.targetControl.$(),e;if(i){e={"grid-column-start":this._mDragItemDimensions.columnsSpan,"grid-row-start":this._mDragItemDimensions.rowsSpan}}else{e={width:this._mDragItemDimensions.rect.width,height:this._mDragItemDimensions.rect.height}}this._$indicator.css(e);if(t.position=="Before"){this._$indicator.insertBefore(r)}else{this._$indicator.insertAfter(r)}this._$indicator.show();this._iDragFromIndex=this._$indicator.index()};r.prototype._hideDraggedItem=function(){this._oDragControl.$().hide();var t=this._findContainingGridItem(this._oDragControl);if(t){t.hide()}};r.prototype._showDraggedItem=function(){this._oDragControl.$().show();var t=this._findContainingGridItem(this._oDragControl);if(t){t.show()}};r.prototype._timeoutOnSamePosition=function(t){if(!this._mLastDropPosition||t.targetControl!==this._mLastDropPosition.targetControl||t.position!=this._mLastDropPosition.position){this._iDropPositionHoldStart=Date.now();this._mLastDropPosition=t;return false}return Date.now()-this._iDropPositionHoldStart>this._iTimeoutBeforeDrop};r.prototype._shouldFreeze=function(t,i){var r=20;return this._mFreezePosition&&Math.abs(this._mFreezePosition.pageX-t)<r&&Math.abs(this._mFreezePosition.pageY-i)<r};r.prototype._freezeCurrentPosition=function(t,i){this._mFreezePosition={pageX:t,pageY:i}};r.prototype._calculateDropPosition=function(t){var i=this._findItemFromPoint(t.pageX,t.pageY),r,e,o;if(!i){r=this._findClosestItem(t.pageX,t.pageY)}if(r){i=r.target}if(r&&r.direction==="Left"){o="After"}if(!i){i=this._getLastItem();o="After"}if(i.hasClass("sapUiDnDGridIndicator")){return null}e=i.control(0,true);if(!o){o=this._calculateDropBeforeOrAfter(e,t)}return{targetControl:e,position:o}};r.prototype._calculateDropBeforeOrAfter=function(t,i){var r=this._getDimensions(t),e=r.rect;if(this._oDragControl===t){return"Before"}if(this._mDragItemDimensions.rect.width*1.5<e.width){var o=window.pageXOffset,n={left:e.left+o,width:e.width},s=i.pageX-n.left;return s<n.width*.5?"Before":"After"}if(this._iDragFromIndex===null){return"Before"}var a=this._oDropContainer.indexOfAggregation(this._sTargetAggregation,t);if(this._iDragFromIndex>a){return"Before"}return"After"};r.prototype._getDimensions=function(t){var i=this._findContainingGridItem(t);if(i){return{rect:i[0].getBoundingClientRect(),columnsSpan:i.css("grid-column-start"),rowsSpan:i.css("grid-row-start")}}return{rect:t.getDomRef().getBoundingClientRect(),columnsSpan:"span 2",rowsSpan:"span 2"}};r.prototype._findContainingGridItem=function(t){var i=t.$(),r=i.parent().css("display");if(r==="grid"||r==="inline-grid"){return i}r=i.parent().parent().css("display");if(r==="grid"||r==="inline-grid"){return i.parent()}return null};r.prototype._getLastItem=function(){var t=this._oDropContainer.getAggregation(this._sTargetAggregation),i;if(t.length){i=t[t.length-1].$()}return i};r.prototype._findItemFromPoint=function(t,r){var e=document.elementFromPoint(t,r),o=i(e).closest(".sapUiDnDGridControl, .sapUiDnDGridIndicator");if(o.hasClass("sapUiDnDGridIndicator")){return o}if(o.hasClass("sapUiDnDGridControl")){return o}return null};r.prototype._findClosestItem=function(t,i){var r=80,e=20,o,n,s=0,a=t-r;while(!o&&a>0&&s<4){o=this._findItemFromPoint(a,i);a-=r;s++}if(o){n="Left"}if(!o&&i-e>0){o=this._findItemFromPoint(t,i-20);n="Top"}return{target:o,direction:n}};var e;r.getInstance=function(){if(!e){e=new r}return e};return r});