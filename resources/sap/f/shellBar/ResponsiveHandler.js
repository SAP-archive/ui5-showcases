/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/m/OverflowToolbarLayoutData","sap/ui/Device","sap/ui/core/theming/Parameters","sap/m/library"],function(t,o,i,e){"use strict";var n=e.OverflowToolbarPriority;var r=function(t){this._oControl=t;this._iREMSize=parseInt(jQuery("body").css("font-size"));this._iChildControlMargin=parseInt(i.get("_sap_f_ShellBar_ChildMargin"));this._iDoubleChildControlMargin=this._iChildControlMargin*2;this._iCoPilotWidth=parseInt(i.get("_sap_f_ShellBar_CoPilotWidth"))+this._iDoubleChildControlMargin;this._iHalfCoPilotWidth=this._iCoPilotWidth/2;this._oDelegate={onAfterRendering:this.onAfterRendering,onBeforeRendering:this.onBeforeRendering};this._oControl.addDelegate(this._oDelegate,false,this);this._fnResize=this._resize;this._oControl._oOverflowToolbar.attachEvent("_controlWidthChanged",this._handleResize,this)};r.prototype.onAfterRendering=function(){var t=o.media.getCurrentRange("Std",this._oControl.$().outerWidth(true)).name==="Phone";this._oButton=this._oControl._oMegaMenu&&this._oControl._oMegaMenu.getAggregation("_button");this._oDomRef=this._oControl.getDomRef();this.bIsMegaMenuConfigured=this._oControl._oTitleControl&&this._oControl._oTitleControl===this._oControl._oMegaMenu;if(this._oControl._oTitleControl){if(this.bIsMegaMenuConfigured&&this._oButton&&this._oButton._image){if(!this.bMenuButtonImageLoadAttached){this._oButton._image.attachEvent("load",this._updateMegaMenuWidth,this);this.bMenuButtonImageLoadAttached=true}}if(!this.bIsMegaMenuConfigured){setTimeout(this._updateMegaMenuWidth.bind(this),0)}}if(this._oControl._oHomeIcon&&!this.bHomeIconLoadAttached){this._oControl._oHomeIcon.attachEvent("load",this._updateHomeIconWidth,this);this.bHomeIconLoadAttached=true}if(this._oControl._oManagedSearch&&!this._bAttachedManagedSearchHandler){this._oControl._oManagedSearch.attachEvent("_updateVisualState",this._switchOpenStateOnSearch,this);this._bAttachedManagedSearchHandler=true}if(t){this._transformTitleControlMobile()}this._initResize();this._handleResize()};r.prototype.exit=function(){if(this._oControl._oOverflowToolbar){this._oControl._oOverflowToolbar.detachEvent("_controlWidthChanged",this._handleResize,this)}if(this._oControl._oHomeIcon){this._oControl._oHomeIcon.detachEvent("load",this._updateHomeIconWidth,this);this.bHomeIconLoadAttached=false}if(this._oButton){this._oButton.detachEvent("load",this._updateMegaMenuWidth,this)}if(this._oControl._oTitleControl&&this.bIsMegaMenuConfigured&&this._oButton&&this._oButton._image){this._oButton._image.detachEvent("load",this._updateMegaMenuWidth,this);this.bMenuButtonImageLoadAttached=false}this._oControl.removeDelegate(this._oDelegate)};r.prototype._initResize=function(){this._iStaticWidth=0;this._iMBWidth=0;this._iStaticWidthForSearch=0;if(this._oControl._oTitleControl){this._iMBWidth=this.getTargetWidth(this._oControl._oTitleControl,true)+this._oControl._oTitleControl._iStaticWidth+this._iDoubleChildControlMargin}this._iTitleWidth=this.getTargetWidth(this._oControl._oSecondTitle);if(this._oControl._oHomeIcon){this._iStaticWidth+=this._oControl._oHomeIcon.$().outerWidth(true)}if(this._oControl._oNavButton){this._iStaticWidth+=36+this._iDoubleChildControlMargin}if(this._oControl._oMenuButton){this._iStaticWidth+=36+this._iChildControlMargin}if(this._oControl._oAvatarButton){this._iStaticWidthForSearch+=36+this._iDoubleChildControlMargin}if(this._oControl._oProductSwitcher||this._oControl._oNotifications||this._oControl.getAdditionalContent()){this._iStaticWidthForSearch+=36+this._iDoubleChildControlMargin}if(this._oControl&&this._oControl._oCopilot){this._iStaticWidthForSearch+=this._iHalfCoPilotWidth}};r.prototype._updateHomeIconWidth=function(){this._initResize();this._fnResize()};r.prototype._updateMegaMenuWidth=function(){this._initResize();this._fnResize()};r.prototype._handleResize=function(){if(!this._oDomRef){return}var t=this._oControl.$(),i=t.outerWidth(),e=o.media.getCurrentRange("Std",i),n;if(e){n=e.name==="Phone";t.toggleClass("sapFShellBarSizeDesktop",e.name==="Desktop");t.toggleClass("sapFShellBarSizeTablet",e.name==="Tablet");t.toggleClass("sapFShellBarSizePhone",n)}if(this._iPreviousWidth===i){return}this._iPreviousWidth=i;if(!this._oControl._oNavButton&&!this._oControl._oMenuButton&&!this._oControl._oHomeIcon&&!this._oControl._oMegaMenu&&!this._oControl._oSecondTitle&&!this._oControl._oCopilot){return}if(n&&!this.bWasInPhoneRange){this._fnResize=this._resizeOnPhone;this._transformToPhoneState()}else if(!n&&this.bWasInPhoneRange){this._fnResize=this._resize;this._transformToRegularState()}setTimeout(this._fnResize.bind(this),0)};r.prototype._switchOpenStateOnSearch=function(){if(this.bWasInPhoneRange){this._transformToPhoneState()}else{this._transformToRegularState()}};r.prototype._transformToPhoneState=function(){var o=this._oControl._oManagedSearch;if(this._oControl._oSecondTitle){this._oControl._oSecondTitle.setVisible(false)}this._transformTitleControlMobile();if(!this._controlsLayoutDataCached){this._cacheControlsLayoutData();this._controlsLayoutDataCached=true}this._oControl._aOverflowControls.forEach(function(o){o.setLayoutData(new t({priority:n.AlwaysOverflow}))});this.bWasInPhoneRange=true;if(o){o.setPhoneMode(true);if(o.getIsOpen()){this._toggleAllControlsExceptSearch(false);this._bSearchWasOpen=true}else if(this._bSearchWasOpen){this._toggleAllControlsExceptSearch(true);this._oControl._oHomeIcon.setVisible(false);this._oControl._oSecondTitle.setVisible(false);this._bSearchWasOpen=false}}this._oControl.invalidate()};r.prototype._transformToRegularState=function(){var t=this._oControl._oManagedSearch;this._toggleAllControlsExceptSearch(true);if(this._oControl._oSecondTitle){this._oControl._oSecondTitle.setVisible(true)}if(this._oControl._oHomeIcon){if(this._oControl._oMegaMenu){this._oControl._oMegaMenu.setWidth("auto").setText(this._oControl._sTitle).setIcon("")}if(this._oControl._oPrimaryTitle){this._oControl._oPrimaryTitle.setWidth("auto").setText(this._oControl._sTitle)}if(this.bIsMegaMenuConfigured){this._oControl._oHomeIcon.setVisible(true)}}if(this._controlsLayoutDataCached){this._restoreControlsLayoutData();this._controlsLayoutDataCached=false}this.bWasInPhoneRange=false;t&&t.setPhoneMode(false);this._oControl.invalidate()};r.prototype._transformTitleControlMobile=function(){if(this._oControl._oHomeIcon){if(this._oControl._oMegaMenu){this._oControl._oMegaMenu.setWidth("auto").setText("").setIcon(this._oControl.getHomeIcon())}if(this._oControl._oPrimaryTitle){this._oControl._oPrimaryTitle.setWidth("0").setText("")}this._oControl._oHomeIcon.setVisible(!this.bIsMegaMenuConfigured)}};r.prototype._resizeOnPhone=function(){var t=this._oControl._getOverflowToolbar().$().width(),o;if(this._oControl._oCopilot){t-=this._iCoPilotWidth;o=t/2-this._iStaticWidth}else{o=t-this._iStaticWidth-this._getWidthOfAllNonManagedControls()}if(!this._oControl._oHomeIcon&&this.bIsMegaMenuConfigured){if(this._iMBWidth>=o){this._oControl._oTitleControl.setWidth(o-this._iDoubleChildControlMargin+"px")}else{this._oControl._oTitleControl.setWidth(this._iMBWidth-this._iDoubleChildControlMargin+"px")}}if(this._oControl._oTitleControl){o-=this._oControl._oTitleControl.$().outerWidth(true)}if(o<0){o=0}this._oControl._oCopilot&&this._oControl._oControlSpacer.setWidth(o+"px")};r.prototype._resize=function(){var t=this._oControl._getOverflowToolbar().$().width(),o,i,e=t/2;if(this._oControl._oManagedSearch&&this._oControl._oManagedSearch.getIsOpen()){this._adaptSearch(e)}if(!this._oControl._oCopilot){i=this._getWidthOfAllNonManagedControls();o=t-i-this._iStaticWidth-8*this._iREMSize;this._adaptManagedWidthControls(o);return}o=e-this._iHalfCoPilotWidth-this._iStaticWidth;this._adaptManagedWidthControls(o)};r.prototype._getWidthOfAllNonManagedControls=function(){var t=this._oControl._oOverflowToolbar.$().children(),o=0;t.filter(function(t,i){var e=jQuery(i),n=e.control(0);if(n===this._oControl._oNavButton){return false}if(n===this._oControl._oMenuButton){return false}if(n===this._oControl._oHomeIcon){return false}if(n===this._oControl._oMegaMenu){return false}if(n===this._oControl._oSecondTitle){return false}if(n===this._oControl._oControlSpacer){return false}if(n===this._oControl._oToolbarSpacer){return false}o+=e.outerWidth(true);return true}.bind(this));return o};r.prototype._adaptSearch=function(t){t=t-this._iStaticWidthForSearch-this._iDoubleChildControlMargin;if(t>464){this._oControl._oManagedSearch.setWidth("464px");return}if(t<192){this._toggleAllControlsExceptSearch(false);this._oControl._oManagedSearch.setWidth("100%");this._oControl._oManagedSearch.setPhoneMode(true);this._bSearchFullWidth=true;return}if(this._bSearchFullWidth){this._toggleAllControlsExceptSearch(true);this._oControl._oManagedSearch.setPhoneMode(false);this._bSearchFullWidth=false}this._oControl._oManagedSearch.setWidth(t+"px")};r.prototype._toggleAllControlsExceptSearch=function(t){this._oControl._oOverflowToolbar.getContent().forEach(function(o){if(o!==this._oControl._oManagedSearch){o.setVisible(t)}}.bind(this))};r.prototype._adaptManagedWidthControls=function(t){var o=!!this._oControl._oTitleControl,i=o?this._iMBWidth:0,e=this._iTitleWidth,n=i+e,r=this._oControl._oSecondTitle,h=this._oControl._oControlSpacer,s,a=80,l;if(t<=0){h&&h.setWidth("0px");r&&r.setWidth("0px");o&&this._oControl._oTitleControl.setWidth(a+"px");return}if(n<0){n=0}if(i<0){i=0}if(i>=t){h&&h.setWidth("0px");r&&r.setWidth("0px");l=t-this._iDoubleChildControlMargin<=a?a:t-this._iDoubleChildControlMargin;o&&this._oControl._oTitleControl.setWidth(l+"px");return}else{l=i-this._iDoubleChildControlMargin<=a?a:i-this._iDoubleChildControlMargin;o&&this._oControl._oTitleControl.setWidth(l+"px")}if(t>=i&&t<=n){s=t-i;if(s<0){s=0}if(s>32){h&&h.setWidth("0px");r&&r.setWidth(s+"px")}else{h&&h.setWidth(s+"px");r&&r.setWidth("0px")}return}else{r&&r.setWidth(e+"px")}if(t>n){h&&h.setWidth(t-n+"px")}};r.prototype._cacheControlsLayoutData=function(){this._oCachedLayoutData={};this._oControl._aOverflowControls.forEach(function(t){this._oCachedLayoutData[t.getId()]=t.getLayoutData()}.bind(this))};r.prototype._restoreControlsLayoutData=function(){this._oControl._aOverflowControls.forEach(function(t){var o=this._oCachedLayoutData[t.getId()];if(o){t.setLayoutData(o)}}.bind(this))};r.prototype.getTargetWidth=function(t,o){if(!t){return 0}var i=t.getText(),e=document.createElement("div"),n=document.createTextNode(i),r=sap.ui.getCore().getStaticAreaRef(),h;e.appendChild(n);e.style.setProperty("white-space","nowrap");e.style.setProperty("display","inline-block");e.style.setProperty("font-size",t._sFontSize);if(o){e.style.setProperty("font-weight","bold")}r.appendChild(e);if(e.getBoundingClientRect){h=e.getBoundingClientRect().width}else{h=e.scrollWidth}h+=1;r.removeChild(e);return h};return r});